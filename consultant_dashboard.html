<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Log Masuk Konsultan - eHalalGAP</title>
    <!-- Favicon Links -->
    <link rel="apple-touch-icon" sizes="180x180" href="https://raw.githubusercontent.com/goldigger79/eHalalGAP/main/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://raw.githubusercontent.com/goldigger79/eHalalGAP/main/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://raw.githubusercontent.com/goldigger79/eHalalGAP/main/favicon-16x16.png">
    <link rel="manifest" href="https://raw.githubusercontent.com/goldigger79/eHalalGAP/main/site.webmanifest">
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Libraries for PDF Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Load Chart.js for visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; }
        .hero-bg { background-color: #1a4f78; }
        .btn-primary { background-color: #0d9488; transition: background-color 0.3s; }
        .btn-primary:hover { background-color: #0f766e; }
        .btn-secondary { background-color: #e5e7eb; color: #374151; transition: background-color 0.3s; }
        .btn-secondary:hover { background-color: #d1d5db; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); display: none; justify-content: center; align-items: center; z-index: 50; overflow-y: auto; padding: 20px; }
        .modal-content { background-color: white; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); width: 95%; max-width: 1200px; max-height: 95vh; overflow-y: auto; position: relative; }
        .print-hidden { display: none !important; }
        .tab-active {
            border-bottom: 2px solid #0d9488;
            color: #0d9488;
            font-weight: 600;
        }
    </style>
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, onSnapshot, collection, query, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- KONFIGURASI FIREBASE ---
        // (Sila gantikan dengan konfigurasi anda sendiri jika perlu)
        const APP_FIREBASE_CONFIG = {
            apiKey: "AIzaSyCll1mrRqrAMAUqzdGqSYSyFBiOpb6y_y4",
            authDomain: "ehalalgap.firebaseapp.com",
            projectId: "ehalalgap",
            storageBucket: "ehalalgap.firebasestorage.app",
            appId: "1:687151615169:web:8ff94f1eed2c6d1d5f1840",
            measurementId: "G-6QBXVD6R0R"
        };
        
        const appId = APP_FIREBASE_CONFIG.projectId;
        const firebaseConfig = APP_FIREBASE_CONFIG;
        
        let app, db, auth;
        let selectedClientData = null; // Store data for the selected client
        let allClients = []; // Store the full list of clients to allow filtering
        let showArchived = false; // State to toggle between active and archived clients

        // --- ALL QUESTIONNAIRE AND SCORING DATA (Copied from client.html) ---
        const flowSteps = [
             { id: 'maklumat', title: '1. Maklumat Perniagaan', type: 'form'},
             { id: 'kategori', title: '2. Kategori Industri', type: 'selection', options: ['Mikro (Jualan Tahunan < RM300,000 ATAU Pekerja < 5 orang)', 'Kecil (Jualan Tahunan RM300,000 - RM 15 juta ATAU Pekerja 5 - 75 orang)', 'Sederhana (Jualan Tahunan RM 15 juta - RM 50 juta ATAU Pekerja 75 - 200 orang)', 'Besar (Jualan Tahunan > RM 50 juta ATAU Pekerja > 200 orang)']},
             { id: 'skim', title: '3. Skim Pensijilan', type: 'selection', options: ['Produk Makanan dan Minuman', 'Produk Kosmetik', 'Produk Farmaseutikal', 'Premis Makanan', 'Produk Barang Gunaan', 'Perkhidmatan Logistik', 'Rumah Sembelihan', 'Pengilangan Kontrak/OEM', 'Produk Peranti Perubatan']},
             { id: 'syarat', title: '4. Umum', type: 'checklist', questions: ["Adakah perniagaan berdaftar dengan Suruhanjaya Perniagaan Malaysia (SSM)?","Adakah perniagaan Telah beroperasi sepenuhnya sekurang-kurangnya 3 bulan?","Adakah perniagaan Memiliki lesen atau kelulusan daripada PBT?","Jika premis makanan, adakah telah mendapat perakuan FOSIM? *","Jika skim kosmetik, adakah telah mendapat perakuan NPRA? *",]},
             { id: 'premis', title: '5. Premis', type: 'qa'},
             { id: 'bahan', title: '6. Bahan Mentah & Peralatan', type: 'qa'},
             { id: 'sanitasi', title: '7. Sanitasi', type: 'qa'},
             { id: 'pekerja', title: '8. Pekerja', type: 'qa'},
             { id: 'dokumentasi', title: '9. Dokumentasi & Rekod', type: 'qa'},
             { id: 'ulasan', title: '10. Ulasan', type: 'textarea'},
             { id: 'result', title: '11. Keputusan & Laporan', type: 'result'}
        ];
        const qaQuestions = {
            premis: ["Adakah premis anda terletak jauh dari dan tidak dicemari oleh ladang babi atau aktiviti pemprosesan tidak halal?", "Adakah premis bebas daripada bahan mentah dan produk tidak halal seperti arak dan daging babi?", "Adakah premis mempunyai mekanisme pengawalan bagi mencegah haiwan peliharaan atau liar, serangga dan haiwan perosak daripada memasuki atau berada di dalam kawasan premis?", "Adakah premis dalam keadaan baik, bersih dan kemas?", "Adakah lantai, dinding, siling, kipas, penghawa dingin, tingkap dan pintu berkeadaan bersih dan tidak menyumbang kepada pencemaran?", "Adakah bekalan air terawat dari Jabatan Bekalan Air (potable water) mencukupi dan dilindungi daripada pencemaran?", "Adakah ruang simpanan bahan mentah dipisahkan daripada ruang simpanan produk siap?", "Adakah terdapat kemudahan sinki untuk basuh tangan yang dilengkapi dengan sabun dan tuala pakai buang/pengering tangan?", "Adakah lantai diperbuat daripada bahan kalis air, tidak menyerap dan mudah dibersihkan?", "Adakah terdapat sistem saliran air yang baik pada lantai pemprosesan?", "Adakah dinding premis licin, kalis air, dan mudah dicuci?", "Adakah siling atau bahagian atas premis direka untuk elak habuk jatuh, kulapuk dan titisan air?", "Adakah pintu premis diperbuat daripada bahan kalis air, mudah dibersihkan, dan ditutup secara kendiri?", "Adakah tingkap yang boleh dibuka dilengkapi dengan jaring/mosquito net untuk elak serangga masuk?","Adakah pencahayaan di kawasan pemprosesan mencukupi dan tidak menyebabkan risiko pencemaran makanan?","Adakah lampu yang berpenutup digunakan di kawasan pemprosesan?","Adakah sistem pengudaraan premis berfungsi baik dan aliran udara bergerak dari kawasan bersih ke kawasan kurang bersih (bukan sebaliknya)?","Adakah bilik air/tandas disediakan dalam jumlah mencukupi?","Adakah bilik air/tandas tidak terus bersambung dengan ruang pemprosesan makanan?","Adakah premis mempunyai stor yang berasingan untuk Bahan mentah?","Adakah premis mempunyai stor yang berasingan untuk Produk siap?","Adakah premis mempunyai stor yang berasingan untuk Bahan kimia/pembersihan?","Adakah premis menyediakan ruang solat kepada pekerja muslim?","Adakah premis menyediakan ruang persalinan kepada pekerja?","Adakah premis menyediakan ruang makan atau rehat kepada pekerja?","Adakah premis menyediakan kemudahan penyimpanan barang peribadi kepada pekerja?","Adakah premis memastikan alat dan unsur penyembahan tidak berada dalam kawasan pemprosesan?","Adakah premis memastikan tempat tinggal pekerja tidak berada dalam kawasan pemprosesan?","Adakah aliran proses pengeluaran makanan dalam premis satu arah (linear flow)?","Adakah terdapat pemisahan kawasan bersih dan kawasan kotor untuk mengelakkan pencemaran?"],
            bahan: ["Adakah semua bahan mentah (termasuk bahan tambahan & bahan pembungkusan primer) mempunyai sijil halal yang sah?","Jika bahan mentah diimport, adakah ia daripada badan pensijilan halal luar negara yang diiktiraf JAKIM?","Adakah rekod pembelian bahan mentah (invois, delivery order) disimpan dan boleh diaudit?","Adakah terdapat sebarang bahan mentah daripada sumber syubhah/diragui?","Adakah bahan mentah halal disimpan berasingan daripada bahan tidak halal/diragui?","Adakah stor bahan mentah dilabel dengan jelas untuk elak kekeliruan (contoh: 'Halal Certified', 'Non-halal', 'Bahan Kimia')?"],
            sanitasi: ["Adakah terdapat sink untuk basuh tangan yang dilengkapi sabun, tisu/pengering automatik, dan air bersih?","Adakah terdapat jadual pembersihan dan sanitasi bertulis yang disediakan dan disemak?","Adakah tong sampah bertutup dan mudah dibersihkan digunakan dalam premis?","Adakah bilik air/tandas Bersih, tidak berbau dan tidak terbuka secara langsung kepada kawasan pemprosesan?","Adakah terdapat sistem kawalan makhluk perosak?"],
            pekerja: ["Adakah perniagaan mempunyai pekerja muslim warganegara?","Adakah pekerja perniagaan telah menerima latihan halal?"],
            dokumentasi: ["Adakah dokumen dan rekod disimpan dengan baik, dikemaskini dan mudah untuk dirujuk?","Adakah perniagaan menyimpan rekod pembelian bahan mentah bersama sijil halal pembekal?"]
        };
        const questionPoints = {
            'syarat': [7, 7, 7, 7, 7], 
            'premis': [7, 7, 5, 3, 7, 7, 7, 7, 7, 7, 7, 7, 7, 5, 5, 7, 7, 5, 7, 7, 7, 7, 7, 7, 5, 3, 7, 5, 7, 7], 
            'bahan': [7, 7, 7, 7, 7, 5], 
            'sanitasi': [5, 5, 3, 5, 5], 
            'pekerja': [7, 5], 
            'dokumentasi': [5, 5] 
        };
        // --------------------------------------------------------------------

        // --- Functions to Calculate Score and Render Report (Adapted from client.html) ---
        const calculateScore = (answers) => {
            const MAX_TOTAL_POINTS = 308;
            let totalPointsScored = 0, totalScoredQuestions = 0, totalAnswered = 0, countYa = 0, countTidak = 0;
            const scoredSections = ['syarat', 'premis', 'bahan', 'sanitasi', 'pekerja', 'dokumentasi'];
            
            scoredSections.forEach(sectionId => {
                const questions = (sectionId === 'syarat') ? flowSteps.find(s => s.id === 'syarat').questions : qaQuestions[sectionId];
                const points = questionPoints[sectionId] || [];
                totalScoredQuestions += questions.length;

                questions.forEach((q, index) => {
                    const answer = answers[`${sectionId}_${index}`];
                    if (answer) {
                        totalAnswered++;
                        let isReadyAnswer = (answer === 'YA');
                        if (sectionId === 'bahan' && index === 3) { isReadyAnswer = (answer === 'TIDAK'); }
                        if ((sectionId === 'syarat' && (index === 3 || index === 4)) || (sectionId === 'bahan' && index === 1)) {
                            isReadyAnswer = (answer === 'YA' || answer === 'Tidak Berkenaan');
                        }
                        if (isReadyAnswer) { totalPointsScored += (points[index] || 0); }
                        if (answer === 'YA' || answer === 'Tidak Berkenaan') { countYa++; } else if (answer === 'TIDAK') { countTidak++; }
                    }
                });
            });

            const readinessScore = MAX_TOTAL_POINTS > 0 ? (totalPointsScored / MAX_TOTAL_POINTS) * 100 : 0;
            return { readinessScore: parseFloat(readinessScore.toFixed(2)), totalPointsScored, totalQuestions: MAX_TOTAL_POINTS, totalAnswered, totalScoredQuestions, answerBreakdown: { ya: countYa, tidak: countTidak, notAnswered: totalScoredQuestions - totalAnswered } };
        };

        const renderPieChart = (answerBreakdown, canvasTarget, onCompleteCallback = null) => {
            let canvasEl = typeof canvasTarget === 'string' ? document.getElementById(canvasTarget) : canvasTarget;
            if (!canvasEl) { if (onCompleteCallback) onCompleteCallback(); return null; }
            const existingChart = Chart.getChart(canvasEl);
            if (existingChart) { existingChart.destroy(); }
            return new Chart(canvasEl, {
                type: 'pie', data: { labels: ['YA (Halal Ready)', 'TIDAK (Perlu Tindakan)', 'Belum Dijawab'], datasets: [{ data: [answerBreakdown.ya, answerBreakdown.tidak, answerBreakdown.notAnswered], backgroundColor: ['#0d9488', '#dc2626', '#e5e7eb'], hoverOffset: 4 }] },
                options: { 
                    responsive: true, 
                    animation: {
                        onComplete: () => { if (onCompleteCallback) onCompleteCallback(); }
                    },
                    plugins: { 
                        legend: { position: 'bottom' }, 
                        title: { display: true, text: 'Analisis Jawapan Keseluruhan' } 
                    } 
                }
            });
        };
        
        const renderGapsTable = (answers, scoredSections) => {
            let allGaps = [];
            scoredSections.forEach(sectionId => {
                const questions = (sectionId === 'syarat') ? flowSteps.find(s => s.id === 'syarat').questions : qaQuestions[sectionId];
                const points = questionPoints[sectionId] || [];
                const secTitle = flowSteps.find(s => s.id === sectionId)?.title.replace(/^\d+\.\s*/, '') || 'Unknown Section'; 
                
                questions.forEach((q, index) => {
                    const answer = answers[`${sectionId}_${index}`];
                    let isGap = false;
                    if (sectionId === 'bahan' && index === 3) { isGap = (answer === 'YA'); } 
                    else { isGap = (answer === 'TIDAK'); }
                    if (isGap) { allGaps.push({ section: secTitle, question: q.replace(/\*/g, '').trim(), pointValue: points[index] || 0 }); }
                });
            });

            if (allGaps.length === 0) return '<p class="text-sm text-green-600 p-4 border rounded-lg bg-green-50">Tiada jurang kritikal dikesan.</p>';

            return `
                <div class="overflow-x-auto shadow-md rounded-lg">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Bahagian</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Soalan Jurang (GAP)</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">Mata Hilang</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${allGaps.map(gap => `
                                <tr class="hover:bg-red-50/50">
                                    <td class="px-6 py-4 text-sm font-medium text-red-700">${gap.section}</td>
                                    <td class="px-6 py-4 text-sm text-gray-900">${gap.question}</td>
                                    <td class="px-6 py-4 text-center text-sm font-bold text-red-600">${gap.pointValue}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>`;
        };
        
        // --- DIUBAH SUAI: Menambah ID pada setiap bahagian untuk PDF ---
        const renderReportContent = (client, answers, score) => {
            const progress = score.readinessScore;
            let status, statusColor, recommendation;

            if (progress >= 80) { status = 'Bersedia'; statusColor = 'bg-green-100 text-green-700 border-green-500'; recommendation = 'Perniagaan menunjukkan ketersediaan tinggi.'; } 
            else if (progress >= 60) { status = 'Kurang Bersedia'; statusColor = 'bg-yellow-100 text-yellow-700 border-yellow-500'; recommendation = 'Perniagaan di tahap sederhana. Fokus pada jurang (GAP) yang dikenal pasti.'; } 
            else { status = 'Tidak Bersedia'; statusColor = 'bg-red-100 text-red-700 border-red-500'; recommendation = 'Perniagaan memerlukan penambahbaikan signifikan.'; }

            const clientReview = answers['ulasan_cabaran_utama'];
            const scoredSections = ['syarat', 'premis', 'bahan', 'sanitasi', 'pekerja', 'dokumentasi'];

            return `
                <div id="pdf-content-container" class="bg-white p-8">
                    <!-- Section 1: Header & Summary -->
                    <div id="pdf-sec-header" class="text-center pb-4 border-b">
                        <h2 class="text-3xl font-extrabold text-gray-800">eHalal<span class="text-teal-600">GAP</span></h2>
                        <h1 class="text-2xl font-bold text-gray-700 mt-2">Laporan Semakan Jurang Halal</h1>
                        <p class="text-lg text-gray-500 mt-1">${client.clientName || 'Tidak Dinamakan'}</p>
                    </div>
                    <div id="pdf-sec-ringkasan" class="mt-8 p-6 rounded-xl shadow-lg border"><h3 class="text-2xl font-bold mb-4 text-center">Ringkasan Keputusan</h3><div class="flex flex-col sm:flex-row items-center justify-around text-center"><div><p class="text-5xl font-extrabold text-teal-600">${progress.toFixed(0)}%</p><p class="text-xl mt-1">Ketersediaan</p></div><div><p class="text-5xl font-extrabold">${score.totalPointsScored}/${score.totalQuestions}</p><p class="text-xl mt-1">Mata Halal</p></div></div></div>
                    <div id="pdf-sec-status" class="mt-8 text-center p-6 rounded-xl border-4 ${statusColor} shadow-md"><p class="text-2xl font-bold">Status: <span class="text-3xl">${status.toUpperCase()}</span></p><p class="mt-4">${recommendation}</p></div>

                    <!-- Section 2: Business Info -->
                    <div id="pdf-sec-maklumat" class="mt-8 p-6 bg-gray-50 rounded-xl shadow-sm border"><h4 class="text-xl font-semibold mb-4 border-b pb-2">Maklumat Perniagaan</h4><div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm font-bold">${['Nama Perniagaan','No SSM (jika ada)','Alamat','No Telefon','Nama Pemilik','Jualan tahunan perniagaan','Bilangan pekerja keseluruhan'].map(f => `<p><strong>${f}:</strong> ${answers[f.toLowerCase().replace(/[^a-z0-9]/g,'_').replace(/_+/g,'_')] || '- '}</p>`).join('')}</div></div>
                    ${clientReview ? `<div id="pdf-sec-ulasan" class="mt-8 p-6 bg-gray-50 rounded-xl shadow-sm border"><h4 class="text-xl font-semibold mb-4 border-b pb-2">Ulasan Klien</h4><p class="text-sm whitespace-pre-wrap">${clientReview}</p></div>` : ''}

                    <!-- Section 3: Pie Chart -->
                    <div id="pdf-sec-piechart" class="mt-8 p-6 bg-white rounded-xl shadow-lg"><h4 class="text-xl font-semibold mb-6 border-b pb-2">Analisis Jawapan</h4><div class="flex justify-center w-full max-w-lg mx-auto"><canvas id="modalReportPieChart" width="400" height="400"></canvas></div></div>

                    <!-- Section 4: Gaps Table -->
                    <div id="pdf-sec-jurang" class="mt-8 p-6 bg-white rounded-xl shadow-lg border-t-4 border-red-500"><h4 class="text-xl font-bold text-red-700 mb-4 border-b pb-2">Jurang Pematuhan Kritikal</h4>${renderGapsTable(answers, scoredSections)}</div>

                    <!-- Section 5: Section Analysis -->
                    <div id="pdf-sec-bahagian" class="mt-8 p-6 bg-white rounded-xl shadow-lg"><h4 class="text-xl font-semibold mb-6 border-b pb-2">Analisis Mengikut Bahagian</h4>${scoredSections.map(sId => { const qs = (sId === 'syarat') ? flowSteps.find(s=>s.id===sId).questions : qaQuestions[sId]; const pts = questionPoints[sId] || []; let secMax=0, secScore=0; pts.forEach(p=>{secMax+=p;}); qs.forEach((q,idx) => { const ans = answers[`${sId}_${idx}`]; let isReady= (ans==='YA'); if(sId==='bahan'&& idx===3) isReady=(ans==='TIDAK'); if(isReady) secScore+=pts[idx]; }); const secPerc = secMax > 0 ? (secScore / secMax) * 100 : 0; const secTitle = flowSteps.find(s=>s.id===sId)?.title.replace(/^\d+\.\s*/, '') || sId; const barColor = secPerc >= 80 ? 'bg-green-500' : secPerc >= 60 ? 'bg-yellow-500' : 'bg-red-500'; return `<div class="mb-6 border-b pb-4"><h5 class="text-lg font-bold">${secTitle}</h5><div class="flex justify-between items-center mb-1"><span class="text-sm">Skor: ${secScore}/${secMax}</span><span class="text-lg font-bold">${secPerc.toFixed(0)}%</span></div><div class="w-full bg-gray-200 rounded-full h-3"><div class="${barColor} h-3 rounded-full" style="width: ${secPerc.toFixed(0)}%"></div></div></div>`; }).join('')}</div>
                    
                    <!-- Footer -->
                    <div id="pdf-sec-footer" class="mt-8 text-xs text-gray-500 text-center pt-4 border-t">&copy; Hak Cipta ACE UniKL MICET 2025.</div>
                </div>`;
        };

        const renderReportCover = () => {
            if (!selectedClientData || !selectedClientData.answers) return '<div>Ralat: Data klien tidak ditemui untuk muka depan.</div>';
            const { answers } = selectedClientData;
            const today = new Date();
            const formattedDate = `${today.getDate().toString().padStart(2, '0')}/${(today.getMonth() + 1).toString().padStart(2, '0')}/${today.getFullYear()}`;
            
            return `
            <div id="pdf-cover-page" class="bg-white p-8" style="width: 210mm; height: 297mm; display: flex; flex-direction: column; justify-content: space-between; border: 1px solid #eee;">
                <div>
                    <h1 class="text-5xl font-extrabold text-gray-800">eHalal<span class="text-teal-600">GAP</span></h1>
                    <p class="text-lg text-gray-500 mt-2">Platform Analisis Kendiri untuk Pensijilan Halal</p>
                </div>
                
                <div class="text-center">
                    <h2 class="text-4xl font-bold text-gray-700">Laporan Semakan Jurang Halal</h2>
                    <div class="mt-12 border-t-2 border-teal-500 w-24 mx-auto"></div>
                    <p class="mt-8 text-3xl font-semibold">${answers.nama_perniagaan || 'Nama Perniagaan'}</p>
                    <!-- Baris berikut dialih keluar seperti yang diminta -->
                    <!-- <p class="mt-2 text-lg text-gray-600">${answers.no_ssm__jika_ada_ || 'No. Pendaftaran'}</p> -->
                </div>
                
                <div class="text-sm text-gray-600">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <p class="font-bold">Disediakan Untuk:</p>
                            <p>${answers.nama_pemilik || answers.nama_perniagaan}</p>
                        </div>
                        <div>
                            <p class="font-bold">Tarikh Laporan:</p>
                            <p>${formattedDate}</p>
                        </div>
                        <div>
                            <p class="font-bold">Disediakan Oleh:</p>
                            <p>Sistem Automasi eHalalGAP</p>
                        </div>
                         <div>
                            <p class="font-bold">ID Laporan:</p>
                            <p>EHG-${today.getTime()}</p>
                        </div>
                    </div>
                    <p class="mt-8 text-xs text-gray-500 italic">Dokumen ini adalah sulit dan mengandungi maklumat proprietari. Ia dihasilkan untuk kegunaan dalaman penerima sahaja dan tidak boleh disebarkan tanpa kebenaran bertulis.</p>
                     <p class="text-center mt-4 text-xs">&copy; Hak Cipta ACE UniKL MICET 2025.</p>
                </div>
            </div>
            `;
        };

        // --- DIUBAH SUAI: Fungsi muat turun PDF untuk menyusun halaman ---
        window.downloadReportPDF = async () => {
            if (!selectedClientData) {
                alert("Sila pilih dan lihat laporan klien terlebih dahulu sebelum memuat turun.");
                return;
            }

            const downloadButton = document.querySelector('#report-modal button[onclick="window.downloadReportPDF()"]');
            const originalButtonText = downloadButton.innerHTML;
            downloadButton.innerHTML = '<span class="animate-pulse">Menjana PDF...</span>';
            downloadButton.disabled = true;

            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = pdf.internal.pageSize.getHeight();
            const margin = 10;
            const contentWidth = pdfWidth - (margin * 2);
            
            // --- 1. Add Cover Page ---
            const tempCoverContainer = document.createElement('div');
            tempCoverContainer.style.position = 'absolute';
            tempCoverContainer.style.left = '-9999px'; // Hide it off-screen
            tempCoverContainer.innerHTML = renderReportCover();
            document.body.appendChild(tempCoverContainer);
            const coverElement = document.getElementById('pdf-cover-page');
            
            const coverCanvas = await html2canvas(coverElement, { scale: 2 });
            const coverImgData = coverCanvas.toDataURL('image/jpeg', 0.98);
            pdf.addImage(coverImgData, 'JPEG', 0, 0, pdfWidth, pdfHeight);
            document.body.removeChild(tempCoverContainer);

            // --- 2. Add Main Report Content ---
            const reportElement = document.getElementById('modal-report-body');
            const { answers, score } = selectedClientData;
            
            // Pastikan carta pai dilukis tanpa animasi untuk ditangkap oleh html2canvas
             if (score.totalAnswered > 0) {
                const originalAnimation = Chart.defaults.animation;
                Chart.defaults.animation = false;
                await new Promise(resolve => renderPieChart(score.answerBreakdown, 'modalReportPieChart', resolve));
                Chart.defaults.animation = originalAnimation;
            }
            await new Promise(r => setTimeout(r, 500)); // Beri masa untuk render

            // Fungsi bantuan untuk mengambil elemen, klon, dan tambah ke halaman PDF
            const addElementsToPage = async (elementIds) => {
                pdf.addPage();
                let yPos = margin;
                
                // Cipta bekas sementara untuk memegang elemen yang diklon
                const tempContainer = document.createElement('div');
                tempContainer.style.position = 'absolute';
                tempContainer.style.left = '-9999px';
                // Tetapkan lebar agar sepadan dengan bekas kandungan asal untuk mengekalkan susun atur
                tempContainer.style.width = reportElement.querySelector('#pdf-content-container').clientWidth + 'px';
                tempContainer.style.backgroundColor = 'white'; // Pastikan latar belakang putih
                tempContainer.style.padding = '32px'; // Padankan p-8 pada #pdf-content-container
                
                for (const id of elementIds) {
                    const el = document.getElementById(id);
                    if (el) {
                        const elClone = el.cloneNode(true);

                        // --- TAMBAHAN BARU: Tukar Kanvas Carta Pai kepada Imej ---
                        // Ini diperlukan kerana html2canvas tidak dapat menangkap kanvas yang diklon
                        if (id === 'pdf-sec-piechart') {
                            // Cari kanvas yang diklon DI DALAM elClone
                            const clonedCanvas = elClone.querySelector('#modalReportPieChart');
                            if (clonedCanvas) {
                                // Dapatkan kanvas asal dari modal
                                const originalCanvas = document.getElementById('modalReportPieChart');
                                if (originalCanvas) {
                                    // Dapatkan data imej dari kanvas ASAL
                                    const imgData = originalCanvas.toDataURL('image/png');
                                    
                                    // Cipta elemen imej baru
                                    const img = document.createElement('img');
                                    img.src = imgData;
                                    
                                    // Salin gaya untuk memastikan saiz konsisten
                                    img.style.width = '100%';
                                    img.style.height = 'auto';
                                    img.style.maxWidth = '400px'; // Padankan saiz asal
                                    img.style.margin = '0 auto'; // Pusatkan
                                    img.style.display = 'block';
                                    
                                    // Gantikan <canvas> yang diklon (kosong) dengan <img> (penuh)
                                    clonedCanvas.parentNode.replaceChild(img, clonedCanvas);
                                }
                            }
                        }
                        // --- AKHIR TAMBAHAN ---

                        tempContainer.appendChild(elClone);
                    }
                }
                document.body.appendChild(tempContainer);

                // Ambil gambar bekas sementara
                const canvas = await html2canvas(tempContainer, { 
                    scale: 2, 
                    useCORS: true, 
                    backgroundColor: '#ffffff' 
                });
                document.body.removeChild(tempContainer); // Bersihkan
                
                const imgData = canvas.toDataURL('image/jpeg', 0.98);
                const imgHeight = (canvas.height * contentWidth) / canvas.width;
                
                let pageHeight = imgHeight;
                
                // Jika kandungan lebih tinggi daripada halaman, pangkas ia (untuk kes mudah)
                // Pilihan yang lebih baik mungkin untuk memuatkan ke halaman
                if (imgHeight > (pdfHeight - (margin * 2))) {
                    pageHeight = pdfHeight - (margin * 2);
                     pdf.addImage(imgData, 'JPEG', margin, yPos, contentWidth, pageHeight, undefined, 'FAST');
                } else {
                     pdf.addImage(imgData, 'JPEG', margin, yPos, contentWidth, imgHeight, undefined, 'FAST');
                }
            };
            
            // --- Halaman 1 (Laporan): Ringkasan & Maklumat ---
            const page1Ids = ['pdf-sec-header', 'pdf-sec-ringkasan', 'pdf-sec-status', 'pdf-sec-maklumat'];
            const ulasanEl = document.getElementById('pdf-sec-ulasan');
            if (ulasanEl) page1Ids.push('pdf-sec-ulasan'); // Tambah ulasan jika wujud
            await addElementsToPage(page1Ids);
            
            // --- Halaman 2 (Laporan): Analisis Jawapan (Carta Pai) ---
            await addElementsToPage(['pdf-sec-piechart']);
            
            // --- Halaman 3 (Laporan): Jurang Pematuhan Kritikal ---
            await addElementsToPage(['pdf-sec-jurang']);
            
            // --- Halaman 4 (Laporan): Analisis Mengikut Bahagian & Footer ---
            await addElementsToPage(['pdf-sec-bahagian', 'pdf-sec-footer']);

            // --- Simpan PDF ---
            const clientName = answers['nama_perniagaan'] || 'laporan-ehalalgap';
            const filename = `${clientName.replace(/\s+/g, '_').toLowerCase()}_${new Date().toISOString().slice(0,10)}.pdf`;
            pdf.save(filename);

            downloadButton.innerHTML = originalButtonText;
            downloadButton.disabled = false;
        };

        window.viewReport = async (userId) => {
            const reportBody = document.getElementById('modal-report-body');
            reportBody.innerHTML = '<p class="text-center p-8">Memuatkan data klien...</p>';
            toggleModal(true);

            try {
                // (Nota Pembangun: Laluan ini mungkin memerlukan pelarasan Security Rules)
                // Cuba dapatkan data terperinci dahulu
                let answers;
                try {
                    const docRef = doc(db, `/artifacts/${appId}/users/${userId}/halal_readiness_assessment/data`);
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        answers = docSnap.data().answers || {};
                    } else {
                        throw new Error("Dokumen data terperinci klien tidak ditemui.");
                    }
                } catch (dataError) {
                     // Jika gagal (cth: kebenaran dinafikan), cuba dapatkan dari data awam sebagai sandaran
                    console.warn("Gagal mendapatkan data terperinci, cuba data awam...", dataError.message);
                    const clientSummaryRef = doc(db, `/artifacts/${appId}/public/data/clients/${userId}`);
                    const clientSummarySnap = await getDoc(clientSummaryRef);
                    if (clientSummarySnap.exists() && clientSummarySnap.data().answers) {
                        answers = clientSummarySnap.data().answers;
                         reportBody.innerHTML = '<p class="text-center p-4 bg-yellow-100 text-yellow-800">Amaran: Gagal memuatkan data terperinci. Menjana laporan berdasarkan data ringkasan. Maklumat mungkin tidak lengkap.</p>' + reportBody.innerHTML;
                    } else {
                         throw new Error("Tiada data (terperinci atau awam) ditemui untuk klien ini.");
                    }
                }

                // Dapatkan data ringkasan klien
                const clientSummaryRef = doc(db, `/artifacts/${appId}/public/data/clients/${userId}`);
                const clientSummarySnap = await getDoc(clientSummaryRef);
                if (!clientSummarySnap.exists()) throw new Error("Dokumen ringkasan klien tidak ditemui.");
                const client = clientSummarySnap.data();
                
                // Jika 'answers' masih tiada pada data klien, gunakan yang kita dapat tadi
                if (!client.answers) {
                    client.answers = answers;
                }

                const score = calculateScore(answers);
                selectedClientData = { client, answers, score };
                
                // Render laporan
                const reportContent = renderReportContent(client, answers, score);
                
                // Tambah pada badan modal
                const currentContent = reportBody.innerHTML.startsWith('<p class="text-center p-8">') ? '' : reportBody.innerHTML;
                reportBody.innerHTML = currentContent + reportContent;


                setTimeout(() => renderPieChart(score.answerBreakdown, 'modalReportPieChart'), 100);

            } catch (error) {
                console.error("Gagal memuatkan laporan klien:", error);
                let detailedErrorMessage = `Gagal memuatkan laporan: ${error.message}.`;
                if (error.code === 'permission-denied' || error.message.includes("Missing or insufficient permissions")) {
                    detailedErrorMessage += `<br><br><div class='mt-4 p-4 bg-orange-100 border-l-4 border-orange-500 text-orange-700 text-left text-sm'>
                        <p class='font-bold'>Nota Pembangun:</p>
                        <p class='mt-2'>Ralat ini mungkin berlaku kerana <b>Peraturan Keselamatan (Security Rules) Firebase</b> tidak membenarkan akaun konsultan membaca data peribadi klien (cth: dari laluan <code>/artifacts/{appId}/users/{userId}/...</code>).</p>
                        <p class='mt-2'>Sistem ini cuba menggunakan data ringkasan dari <code>/artifacts/{appId}/public/data/clients/{userId}</code> sebagai sandaran, tetapi pastikan peraturan anda membenarkan sekurang-kurangnya bacaan itu.</p>
                        </div>`;
                }
                reportBody.innerHTML = `<div class="p-8 text-red-600 text-center">${detailedErrorMessage}</div>`;
            }
        };

        const toggleModal = (show) => {
            document.getElementById('report-modal').style.display = show ? 'flex' : 'none';
        };
        window.toggleModal = toggleModal;

        const showLogin = () => {
            document.getElementById('loading-container').style.display = 'none';
            document.getElementById('dashboard-container').style.display = 'none';
            document.getElementById('login-container').style.display = 'flex';
        };

        const showDashboard = () => {
            document.getElementById('loading-container').style.display = 'none';
            document.getElementById('login-container').style.display = 'none';
            document.getElementById('dashboard-container').style.display = 'block';
        };
        
        window.handleConsultantLogin = async () => {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const errorMessage = document.getElementById('auth-error-message');
            errorMessage.textContent = '';

            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                console.error("Login failed:", error);
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                    errorMessage.textContent = 'Emel atau kata laluan tidak sah.';
                } else {
                    errorMessage.textContent = 'Ralat log masuk. Sila cuba lagi.';
                }
            }
        };
        
        window.logoutConsultant = async () => {
            await signOut(auth);
        };

        window.toggleArchiveView = () => {
            showArchived = !showArchived;
            const toggleButton = document.getElementById('archive-toggle-btn');
            if (toggleButton) {
                toggleButton.textContent = showArchived ? 'Lihat Klien Aktif' : 'Lihat Arkib';
            }
            renderClientList();
        };

        window.archiveClient = async (userId, status) => {
            const clientDocRef = doc(db, `/artifacts/${appId}/public/data/clients`, userId);
            try {
                await updateDoc(clientDocRef, { isArchived: status });
                // The onSnapshot listener will automatically refresh the list.
            } catch (error) {
                console.error("Gagal mengemas kini status arkib klien:", error);
                alert("Gagal mengarkibkan klien. Sila cuba lagi.");
            }
        };

        function renderClientList() {
            const tableBody = document.getElementById('client-list-body');
            if (!tableBody) return;

            const filteredClients = allClients.filter(client => showArchived ? client.isArchived === true : client.isArchived !== true);
            const resultStepIndex = flowSteps.findIndex(step => step.id === 'result');

            if (filteredClients.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="6" class="text-center p-4">${showArchived ? 'Tiada klien diarkibkan.' : 'Tiada klien aktif.'}</td></tr>`;
                return;
            }

            tableBody.innerHTML = filteredClients.map(client => {
                let statusText, statusColor;
                
                if (client.currentStepIndex === resultStepIndex) {
                    statusText = 'Selesai';
                    statusColor = 'bg-green-100 text-green-800';
                } else if (client.currentStepIndex > 0) {
                    statusText = 'Sedang Berjalan';
                    statusColor = 'bg-yellow-100 text-yellow-800';
                } else {
                    statusText = 'Belum Mula';
                    statusColor = 'bg-gray-100 text-gray-800';
                }

                const archiveButtonText = showArchived ? 'Nyaharkib' : 'Arkib';
                const archiveFunctionCall = `window.archiveClient('${client.userId}', ${!showArchived})`;
                const archiveButtonClass = showArchived ? 'bg-blue-100 text-blue-800 hover:bg-blue-200' : 'bg-gray-100 text-gray-800 hover:bg-gray-200';

                return `
                    <tr class="hover:bg-gray-50">
                        <td class="p-4 font-medium">${client.clientName || 'Client Baru'}</td>
                        <td class="p-4 text-xs text-gray-600">${client.userId}</td>
                        <td class="p-4 font-bold text-teal-700">${parseFloat(client.readinessScore).toFixed(0)}%</td>
                        <td class="p-4">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusColor}">
                                ${statusText}
                            </span>
                        </td>
                        <td class="p-4 text-sm">${new Date(client.lastUpdated).toLocaleString('ms-MY')}</td>
                        <td class="p-4 space-x-2">
                            <button onclick="viewReport('${client.userId}')" class="btn-primary text-white px-3 py-1 rounded-md text-sm">Laporan</button>
                            <button onclick="${archiveFunctionCall}" class="${archiveButtonClass} px-3 py-1 rounded-md text-sm">${archiveButtonText}</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        window.onload = () => {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            // --- SENARAI UID KONSULTAN YANG DIBENARKAN ---
            // (Tambah UID konsultan anda di sini)
            const consultantUIDs = [
                "7XtS5IWBTpgKryjAvONtXALd8R03", // UID untuk a@b.com
                "A2nVUfDEVkhQPyTf8tUkCoXmQeJ3"  // UID untuk admin@ehalal.com
                // "UID_KONSULTAN_LAIN_DI_SINI"
            ];

            onAuthStateChanged(auth, (user) => {
                if (user && consultantUIDs.includes(user.uid)) {
                    console.log("Akses konsultan dibenarkan untuk:", user.email);
                    showDashboard();
                    loadClients();
                } else {
                    if(user) { 
                        console.log("Akses ditolak untuk:", user.email, "Bukan UID konsultan.");
                        signOut(auth); 
                    } else {
                        console.log("Tiada pengguna log masuk.");
                    }
                    showLogin();
                }
            });
        };

        function loadClients() {
            const clientsCollection = collection(db, `/artifacts/${appId}/public/data/clients`);
            const q = query(clientsCollection);
            const tableBody = document.getElementById('client-list-body');

            if (tableBody) {
                 tableBody.innerHTML = `<tr><td colspan="6" class="text-center p-8">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-teal-500 mx-auto"></div>
                    <p class="mt-2">Memuatkan senarai klien...</p>
                </td></tr>`;
            }

            onSnapshot(q, (snapshot) => {
                allClients = snapshot.docs.map(doc => doc.data());
                // Isih klien mengikut tarikh kemas kini terakhir (terbaru dahulu)
                allClients.sort((a, b) => b.lastUpdated - a.lastUpdated);
                renderClientList(); 
            }, (error) => {
                console.error("Gagal memuatkan senarai klien: ", error);
                if(tableBody) {
                    let errorMsg = 'Ralat memuatkan data klien.';
                    if (error.code === 'permission-denied') {
                        errorMsg = "Ralat Kebenaran: Akaun anda tidak mempunyai kebenaran untuk membaca senarai klien. Sila semak Peraturan Keselamatan (Security Rules) Firestore anda.";
                    }
                    tableBody.innerHTML = `<tr><td colspan="6" class="text-center p-4 text-red-600">${errorMsg}</td></tr>`;
                }
            });
        }
    </script>
</head>
<body>
    <div id="loading-container" class="h-screen flex items-center justify-center">
        <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-teal-500"></div>
        <p class="ml-4 text-teal-600">Mengesahkan Akses...</p>
    </div>

    <div id="login-container" class="h-screen items-center justify-center p-4" style="display: none;">
        <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-md">
            <h1 class="text-3xl font-bold mb-6 text-center text-gray-800">Log Masuk Konsultan</h1>
            <div class="space-y-4">
                <input type="email" id="email" placeholder="Alamat Emel" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500" />
                <input type="password" id="password" placeholder="Kata Laluan" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500" />
                <p id="auth-error-message" class="text-sm text-red-500 text-center h-4"></p>
                <button onclick="handleConsultantLogin()" class="w-full btn-primary text-white py-3 rounded-xl font-semibold shadow-md hover:shadow-lg">
                    Log Masuk
                </button>
            </div>
             <p class="mt-6 text-xs text-center">
                <a href="index.html" class="text-teal-600 hover:text-teal-800 font-medium">
                    &larr; Kembali ke Halaman Utama
                </a>
            </p>
        </div>
    </div>
    
    <div id="dashboard-container" class="min-h-screen flex-col" style="display: none;">
        <!-- Header -->
        <header class="hero-bg py-4 px-4 shadow-lg">
            <div class="max-w-7xl mx-auto text-white flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold">Dashboard Konsultan eHalalGAP</h1>
                    <p class="text-sm text-gray-200">Senarai Klien & Kemajuan Penilaian</p>
                </div>
                <button onclick="logoutConsultant()" class="bg-red-500 text-white hover:bg-red-600 px-4 py-2 rounded-lg text-sm font-semibold">Log Keluar</button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-grow max-w-7xl mx-auto py-8 w-full px-4 sm:px-6 lg:px-8">
             <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">Senarai Klien Berdaftar</h2>
                <button onclick="window.toggleArchiveView()" id="archive-toggle-btn" class="btn-secondary text-sm px-4 py-2 rounded-lg">Lihat Arkib</button>
            </div>
            
            <div class="bg-white rounded-xl shadow-2xl overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="p-4 text-left text-xs font-medium text-gray-500 uppercase">Nama Perniagaan</th>
                                <th class="p-4 text-left text-xs font-medium text-gray-500 uppercase">ID Klien</th>
                                <th class="p-4 text-left text-xs font-medium text-gray-500 uppercase">Skor</th>
                                <th class="p-4 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                <th class="p-4 text-left text-xs font-medium text-gray-500 uppercase">Terakhir Dikemaskini</th>
                                <th class="p-4 text-left text-xs font-medium text-gray-500 uppercase">Tindakan</th>
                            </tr>
                        </thead>
                        <tbody id="client-list-body" class="divide-y divide-gray-200">
                            <!-- Client list will be rendered here by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
        
        <!-- Footer -->
        <footer class="bg-gray-800 text-white p-4">
            <div class="max-w-7xl mx-auto text-center text-sm">
                <p>&copy; Hak Cipta ACE UniKL MICET 2025.</p>
            </div>
        </footer>
    </div>

    <!-- Report Preview Modal -->
    <div id="report-modal" class="modal">
        <div class="modal-content">
            <div class="sticky top-0 bg-white border-b p-4 flex justify-between items-center rounded-t-xl z-10">
                <h2 class="text-2xl font-bold text-gray-800">Laporan Penuh Klien</h2>
                <button onclick="window.toggleModal(false)" class="text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button>
            </div>
            <!-- Badan modal ini akan diisi oleh renderReportContent -->
            <div id="modal-report-body" class="overflow-y-auto"></div>
            <div class="sticky bottom-0 bg-gray-50 border-t p-4 flex justify-center space-x-4 rounded-b-xl z-10">
                <button onclick="window.toggleModal(false)" class="btn-secondary px-6 py-2 rounded-xl">Tutup</button>
                <button onclick="window.downloadReportPDF()" class="btn-primary text-white px-6 py-2 rounded-xl">Muat Turun PDF</button>
            </div>
        </div>
    </div>
</body>
</html>


