<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Semakan Jurang Halal (eHalalGAP)</title>
    <!-- Favicon Links -->
    <link rel="apple-touch-icon" sizes="180x180" href="https://raw.githubusercontent.com/goldigger79/eHalalGAP/main/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://raw.githubusercontent.com/goldigger79/eHalalGAP/main/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://raw.githubusercontent.com/goldigger79/eHalalGAP/main/favicon-16x16.png">
    <link rel="manifest" href="https://raw.githubusercontent.com/goldigger79/eHalalGAP/main/site.webmanifest">
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Libraries for PDF Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Load Chart.js for visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        /* Custom styles for professional look and font */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        .hero-bg {
            background-color: #1a4f78; /* Deep professional blue */
        }
        .btn-primary {
            background-color: #0d9488; /* Teal/Turquoise for action */
            transition: background-color 0.3s;
        }
        .btn-primary:hover {
            background-color: #0f766e;
        }
        .btn-secondary {
            background-color: #e5e7eb;
            color: #374151;
            transition: background-color 0.3s;
        }
        .btn-secondary:hover {
            background-color: #d1d5db;
        }
        .tab-active {
            border-bottom: 4px solid #0d9488;
            color: #0d9488;
            font-weight: 600;
        }
        /* Custom CSS for Progress Bar (Doughnut Chart Style) */
        .progress-ring {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: conic-gradient(#0d9488 0%, #0d9488 var(--progress), #e5e7eb var(--progress), #e5e7eb 100%);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .progress-ring-inner {
            width: 90px;
            height: 90px;
            background-color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: 700;
            color: #0d9488;
        }
        /* Style for PDF container to ensure clean output */
        #pdf-content-container {
            background-color: white;
            color: black;
            font-family: 'Inter', sans-serif;
        }
        /* New custom CSS for unconstrained logo size, ensuring responsiveness */
        .logo-img {
            max-width: 100%; /* Ensures it scales down on mobile if too large */
            height: auto;
            display: block;
        }
        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 50;
            overflow-y: auto;
            padding: 20px;
        }
        .modal-content {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            width: 95%;
            max-width: 1200px;
            max-height: 95vh;
            overflow-y: auto;
            position: relative;
        }

        /* Print-specific styles */
        @media print {
             /* Pastikan hanya laporan dicetak */
            body * {
                visibility: hidden;
            }
            /* FIX: Ensure the modal container itself is also visible */
            #report-modal,
            #modal-report-body,
            #modal-report-body * {
                visibility: visible;
            }
            #report-modal {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                background: white;
                display: block !important;
                padding: 0;
                margin: 0;
            }
            .modal-content {
                box-shadow: none;
                border: none;
                width: 100%;
                max-width: 100%;
                border-radius: 0;
            }
            .print-hidden {
                display: none !important;
            }
            /* Tambah kawalan saiz & scaling A4 */
            #modal-report-body {
                width: 210mm;      /* Lebar A4 */
                min-height: 297mm;    /* Tinggi A4 */
                margin: 0 auto;
                padding: 20mm;
                box-sizing: border-box;
                transform: scale(0.9);  /* Laraskan jika masih terlalu besar */
                transform-origin: top center;
            }
            @page {
                size: A4;
                margin: 10mm; /* margin fizikal cetak */
            }
        }
    </style>
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, createUserWithEmailAndPassword, signInWithEmailAndPassword, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, setLogLevel, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL FIREBASE VARIABLES (MANDATORY USE) ---
        const APP_FIREBASE_CONFIG = {
            apiKey: "AIzaSyCll1mrRqrAMAUqzdGqSYSyFBiOpb6y_y4",
            authDomain: "ehalalgap.firebaseapp.com",
            projectId: "ehalalgap",
            storageBucket: "ehalalgap.firebasestorage.app",
            appId: "1:687151615169:web:8ff94f1eed2c6d1d5f1840",
            measurementId: "G-6QBXVD6R0R"
        };
        
        const appId = APP_FIREBASE_CONFIG.projectId;
        const firebaseConfig = APP_FIREBASE_CONFIG;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null; 
        
        let app = null;
        window.db = null;
        window.auth = null;

        window.appState = {
            isAuthenticated: false,
            authReady: false,
            userId: null,
            currentStep: 0,
            answers: {},
            isPaidClient: false, 
            isRegisterMode: false,
            assessmentCompleted: false // NEW: Flag to track if assessment is finalized
        };
        
        // UPDATED a new flowSteps
        const flowSteps = [
            { id: 'maklumat', title: '1. Maklumat Perniagaan', type: 'form', description: 'Sila isikan maklumat asas perniagaan anda.'},
            { id: 'kategori', title: '2. Kategori Industri', type: 'selection', description: 'Sila pilih **salah satu** kategori industri perniagaan anda.', options: ['Mikro (Jualan Tahunan < RM300,000 ATAU Pekerja < 5 orang)', 'Kecil (Jualan Tahunan RM300,000 - RM 15 juta ATAU Pekerja 5 - 75 orang)', 'Sederhana (Jualan Tahunan RM 15 juta - RM 50 juta ATAU Pekerja 75 - 200 orang)', 'Besar (Jualan Tahunan > RM 50 juta ATAU Pekerja > 200 orang)']},
            { id: 'skim', title: '3. Skim Pensijilan', type: 'selection', description: 'Sila pilih **salah satu** skim pensijilan Halal yang berkaitan dengan jenis perniagaan anda.', options: ['Produk Makanan dan Minuman', 'Produk Kosmetik', 'Produk Farmaseutikal', 'Premis Makanan', 'Produk Barang Gunaan', 'Perkhidmatan Logistik', 'Rumah Sembelihan', 'Pengilangan Kontrak/OEM', 'Produk Peranti Perubatan']},
            { id: 'syarat', title: '4. Umum', type: 'checklist', description: 'Sila semak sama ada perniagaan anda memenuhi syarat-syarat asas ini.', questions: ["Adakah perniagaan berdaftar dengan Suruhanjaya Perniagaan Malaysia (SSM)?", "Adakah perniagaan Telah beroperasi sepenuhnya sekurang-kurangnya 3 bulan?", "Adakah perniagaan Memiliki lesen atau kelulusan daripada PBT?", "Jika premis makanan, adakah telah mendapat perakuan FOSIM? *", "Jika skim kosmetik, adakah telah mendapat perakuan NPRA? *"]},
            { id: 'premis', title: '5. Premis', type: 'qa', description: 'Soalan berkaitan lokasi, struktur, dan pelan lantai premis.'},
            { id: 'bahan', title: '6. Bahan Mentah & Peralatan', type: 'qa', description: 'Soalan berkaitan bahan mentah, penyimpanan, dan peralatan.'},
            { id: 'sanitasi', title: '7. Sanitasi', type: 'qa', description: 'Soalan berkaitan kebersihan dan kawalan makhluk perosak.'},
            { id: 'pekerja', title: '8. Pekerja', type: 'qa', description: 'Soalan berkaitan pekerja dan latihan halal.'},
            { id: 'dokumentasi', title: '9. Dokumentasi & Rekod', type: 'qa', description: 'Soalan berkaitan sistem dokumentasi dan rekod perniagaan.'},
            { id: 'ulasan', title: '10. Ulasan', type: 'textarea', description: 'Sila kongsikan pandangan dan cabaran utama anda.' },
            { id: 'result', title: '11. Keputusan & Laporan', type: 'result', description: 'Laporan Ketersediaan Halal JAKIM anda.' }
        ];

        const qaQuestions = {
            premis: ["Adakah premis anda terletak jauh dari dan tidak dicemari oleh ladang babi atau aktiviti pemprosesan tidak halal?","Adakah premis bebas daripada bahan mentah dan produk tidak halal seperti arak dan daging babi?","Adakah premis mempunyai mekanisme pengawalan bagi mencegah haiwan peliharaan atau liar, serangga dan haiwan perosak daripada memasuki atau berada di dalam kawasan premis?","Adakah premis dalam keadaan baik, bersih dan kemas?","Adakah lantai, dinding, siling, kipas, penghawa dingin, tingkap dan pintu berkeadaan bersih dan tidak menyumbang kepada pencemaran?","Adakah bekalan air terawat dari Jabatan Bekalan Air (potable water) mencukupi dan dilindungi daripada pencemaran?","Adakah ruang simpanan bahan mentah dipisahkan daripada ruang simpanan produk siap?","Adakah terdapat kemudahan sinki untuk basuh tangan yang dilengkapi dengan sabun dan tuala pakai buang/pengering tangan?","Adakah lantai diperbuat daripada bahan kalis air, tidak menyerap dan mudah dibersihkan?","Adakah terdapat sistem saliran air yang baik pada lantai pemprosesan?","Adakah dinding premis licin, kalis air, dan mudah dicuci?","Adakah siling atau bahagian atas premis direka untuk elak habuk jatuh, kulapuk dan titisan air?","Adakah pintu premis diperbuat daripada bahan kalis air, mudah dibersihkan, dan ditutup secara kendiri?","Adakah tingkap yang boleh dibuka dilengkapi dengan jaring/mosquito net untuk elak serangga masuk?","Adakah pencahayaan di kawasan pemprosesan mencukupi dan tidak menyebabkan risiko pencemaran makanan?","Adakah lampu yang berpenutup digunakan di kawasan pemprosesan?","Adakah sistem pengudaraan premis berfungsi baik dan aliran udara bergerak dari kawasan bersih ke kawasan kurang bersih (bukan sebaliknya)?","Adakah bilik air/tandas disediakan dalam jumlah mencukupi?","Adakah bilik air/tandas tidak terus bersambung dengan ruang pemprosesan makanan?","Adakah premis mempunyai stor yang berasingan untuk Bahan mentah?","Adakah premis mempunyai stor yang berasingan untuk Produk siap?","Adakah premis mempunyai stor yang berasingan untuk Bahan kimia/pembersihan?","Adakah premis menyediakan ruang solat kepada pekerja muslim?","Adakah premis menyediakan ruang persalinan kepada pekerja?","Adakah premis menyediakan ruang makan atau rehat kepada pekerja?","Adakah premis menyediakan kemudahan penyimpanan barang peribadi kepada pekerja?","Adakah premis memastikan alat dan unsur penyembahan tidak berada dalam kawasan pemprosesan?","Adakah premis memastikan tempat tinggal pekerja tidak berada dalam kawasan pemprosesan?","Adakah aliran proses pengeluaran makanan dalam premis satu arah (linear flow)?","Adakah terdapat pemisahan kawasan bersih dan kawasan kotor untuk mengelakkan pencemaran?"],
            bahan: ["Adakah semua bahan mentah (termasuk bahan tambahan & bahan pembungkusan primer) mempunyai sijil halal yang sah?","Jika bahan mentah diimport, adakah ia daripada badan pensijilan halal luar negara yang diiktiraf JAKIM?","Adakah rekod pembelian bahan mentah (invois, delivery order) disimpan dan boleh diaudit?","Adakah terdapat sebarang bahan mentah daripada sumber syubhah/diragui?","Adakah bahan mentah halal disimpan berasingan daripada bahan tidak halal/diragui?","Adakah stor bahan mentah dilabel dengan jelas untuk elak kekeliruan (contoh: 'Halal Certified', 'Non-halal', 'Bahan Kimia')?"],
            sanitasi: ["Adakah terdapat sink untuk basuh tangan yang dilengkapi sabun, tisu/pengering automatik, dan air bersih?","Adakah terdapat jadual pembersihan dan sanitasi bertulis yang disediakan dan disemak?","Adakah tong sampah bertutup dan mudah dibersihkan digunakan dalam premis?","Adakah bilik air/tandas Bersih, tidak berbau dan tidak terbuka secara langsung kepada kawasan pemprosesan?","Adakah terdapat sistem kawalan makhluk perosak?"],
            pekerja: ["Adakah perniagaan mempunyai pekerja muslim warganegara?","Adakah pekerja perniagaan telah menerima latihan halal?"],
            dokumentasi: ["Adakah dokumen dan rekod disimpan dengan baik, dikemaskini dan mudah untuk dirujuk?","Adakah perniagaan menyimpan rekod pembelian bahan mentah bersama sijil halal pembekal?"]
        };

        const questionPoints = {
            'syarat': [7, 7, 7, 7, 7], 
            'premis': [7, 7, 5, 3, 7, 7, 7, 7, 7, 7, 7, 7, 7, 5, 5, 7, 7, 5, 7, 7, 7, 7, 7, 7, 5, 3, 7, 5, 7, 7], 
            'bahan': [7, 7, 7, 7, 7, 5], 
            'sanitasi': [5, 5, 3, 5, 5], 
            'pekerja': [7, 5], 
            'dokumentasi': [5, 5] 
        };

        const getClientDocRef = (userId) => doc(window.db, `/artifacts/${appId}/users/${userId}/halal_readiness_assessment`, 'data');
        const getPublicSummaryDocRef = (userId) => doc(window.db, `/artifacts/${appId}/public/data/clients`, userId);
        
        const savePublicSummary = async (userId, dataToSave, score) => {
            try {
                const docRef = getPublicSummaryDocRef(userId);
                const summaryData = {
                    userId: userId,
                    clientName: dataToSave.answers['nama_perniagaan'] || 'Klien Baru',
                    currentStepTitle: flowSteps[dataToSave.currentStep].title,
                    currentStepIndex: dataToSave.currentStep,
                    totalSteps: flowSteps.length,
                    progressPercentage: ((dataToSave.currentStep / flowSteps.length) * 100).toFixed(0),
                    readinessScore: score.readinessScore.toFixed(2),
                    totalPointsScored: score.totalPointsScored,
                    lastUpdated: new Date().toISOString()
                };
                await setDoc(docRef, summaryData, { merge: true });
            } catch (error) {
                console.error("Error saving public summary for client", userId, ":", error); 
            }
        };
        
        // This function only updates the state object and saves to Firestore. It does NOT re-render the UI.
        const updateStateAndSave = async (newState) => {
             window.appState = { ...window.appState, ...newState };
            
            if (window.appState.authReady && window.appState.isAuthenticated && window.appState.userId) {
                try {
                    const privateDocRef = getClientDocRef(window.appState.userId);
                    const dataToSave = {
                        currentStep: window.appState.currentStep,
                        answers: window.appState.answers,
                        assessmentCompleted: window.appState.assessmentCompleted
                    };
                    const score = window.calculateScore();
                    
                    // The saving logic can remain here
                    await setDoc(privateDocRef, dataToSave, { merge: true });
                    await savePublicSummary(window.appState.userId, dataToSave, score);
                    
                } catch (error) {
                    console.error("Error saving data to Firestore:", error);
                }
            }
        };

        // This function updates state AND re-renders the entire app UI.
        window.updateState = async (newState) => {
            window.appState = { ...window.appState, ...newState };
            window.renderApp(); // Full re-render
            await updateStateAndSave({}); // Save the latest state
        };

        window.manualSave = () => {
            updateStateAndSave({}); // Just save without re-rendering
            const statusMessage = document.getElementById('save-status-message');
            if (statusMessage) {
                const timestamp = new Date().toLocaleTimeString('ms-MY', { hour: '2-digit', minute: '2-digit' });
                statusMessage.textContent = `âœ… Kemajuan Disimpan: ${timestamp}`;
                statusMessage.classList.remove('opacity-0', 'text-gray-500');
                statusMessage.classList.add('opacity-100', 'text-teal-600', 'font-medium');
                setTimeout(() => {
                    statusMessage.classList.remove('opacity-100', 'text-teal-600', 'font-medium');
                    statusMessage.classList.add('opacity-0', 'text-gray-500');
                }, 3000);
            }
        };
        
        window.logoutClient = async () => {
            if (window.auth) {
                try {
                    await signOut(window.auth);
                    window.location.href = 'index.html'; 
                } catch (error) {
                    console.error("Error signing out:", error);
                    alert("Gagal log keluar. Sila cuba lagi.");
                }
            }
        };

        window.handleAuth = async (isRegister) => {
            if (!window.auth) {
                 console.error("Authentication failed: Firebase Auth not initialized.");
                 document.getElementById('auth-error-message').textContent = "Ralat sistem: Gagal memulakan perkhidmatan log masuk.";
                 return;
            }
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const errorMessageElement = document.getElementById('auth-error-message');
            errorMessageElement.textContent = '';
            errorMessageElement.classList.remove('p-3', 'bg-red-100', 'border', 'border-red-400', 'rounded-lg');

            if (!email || !password) {
                errorMessageElement.textContent = "Sila masukkan emel dan kata laluan.";
                errorMessageElement.classList.add('p-3', 'bg-red-100', 'border', 'border-red-400', 'rounded-lg');
                return;
            }
            if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                errorMessageElement.textContent = "Sila masukkan format emel yang sah.";
                 errorMessageElement.classList.add('p-3', 'bg-red-100', 'border', 'border-red-400', 'rounded-lg');
                return;
            }

            try {
                if (isRegister) {
                    await createUserWithEmailAndPassword(window.auth, email, password);
                } else {
                    await signInWithEmailAndPassword(window.auth, email, password);
                }
            } catch (error) {
                console.error("Authentication failed:", error);
                let displayMessage = "Gagal log masuk. Sila cuba lagi.";
                if (error.code === 'auth/operation-not-allowed') {
                    displayMessage = "Ralat Konfigurasi: Log Masuk Emel/Kata Laluan belum diaktifkan.";
                } else if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                    displayMessage = "Emel atau kata laluan tidak sah. Sila semak semula.";
                } else if (error.code === 'auth/email-already-in-use') {
                    displayMessage = "Emel ini sudah berdaftar. Sila Log Masuk.";
                    window.updateState({ isRegisterMode: false });
                    return;
                } else if (error.code === 'auth/invalid-email') {
                    displayMessage = "Format emel tidak sah.";
                } else if (error.code === 'auth/weak-password') {
                    displayMessage = "Kata laluan terlalu lemah (minimum 6 aksara).";
                }
                errorMessageElement.textContent = displayMessage;
                errorMessageElement.classList.add('p-3', 'bg-red-100', 'border', 'border-red-400', 'rounded-lg');
            }
        };

        window.onload = async () => {
            try {
                app = initializeApp(firebaseConfig);
                window.db = getFirestore(app);
                window.auth = getAuth(app);

                onAuthStateChanged(window.auth, async (user) => {
                    if (user) {
                        const userId = user.uid;
                        window.appState = { ...window.appState, isAuthenticated: true, userId: userId, authReady: true };
                        console.log("Authenticated with user ID:", userId);
                        
                        const publicSummaryRef = getPublicSummaryDocRef(userId);
                        const publicSummarySnap = await getDoc(publicSummaryRef);

                        if (!publicSummarySnap.exists()) {
                            console.log(`Creating initial public summary for new user: ${userId}`);
                            const initialData = { answers: {}, currentStep: 0 };
                            const initialScore = { readinessScore: 0, totalPointsScored: 0 };
                            await savePublicSummary(userId, initialData, initialScore);
                        }

                        const privateDocRef = getClientDocRef(userId);
                        onSnapshot(privateDocRef, (docSnap) => {
                            if (docSnap.exists()) {
                                const data = docSnap.data();
                                window.appState = { ...window.appState, currentStep: data.currentStep || 0, answers: data.answers || {}, assessmentCompleted: data.assessmentCompleted || false };
                            }
                            window.renderApp();
                        }, (error) => {
                            console.error("Error setting up onSnapshot:", error);
                            window.renderApp();
                        });

                    } else {
                        window.appState = { ...window.appState, isAuthenticated: false, authReady: true };
                        window.renderApp();
                    }
                });
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                window.appState = { ...window.appState, authReady: true };
                window.renderApp();
            }
        };

        window.calculateScore = () => {
            const MAX_TOTAL_POINTS = 308;
            let totalPointsScored = 0, totalScoredQuestions = 0, totalAnswered = 0, countYa = 0, countTidak = 0;
            const scoredSections = ['syarat', 'premis', 'bahan', 'sanitasi', 'pekerja', 'dokumentasi'];
            
            scoredSections.forEach(sectionId => {
                const questions = (sectionId === 'syarat') ? flowSteps.find(s => s.id === 'syarat').questions : qaQuestions[sectionId];
                const points = questionPoints[sectionId] || [];
                totalScoredQuestions += questions.length;

                questions.forEach((q, index) => {
                    const answer = window.appState.answers[`${sectionId}_${index}`];
                    if (answer) {
                        totalAnswered++;
                        let isReadyAnswer = (answer === 'YA');

                        if (sectionId === 'bahan' && index === 3) { 
                            isReadyAnswer = (answer === 'TIDAK'); 
                        }
                        
                        if ( (sectionId === 'syarat' && (index === 3 || index === 4)) || (sectionId === 'bahan' && index === 1) ) {
                            isReadyAnswer = (answer === 'YA' || answer === 'Tidak Berkenaan');
                        }

                        if (isReadyAnswer) { 
                            totalPointsScored += points[index] || 0; 
                        } 
                        
                        if (answer === 'YA' || answer === 'Tidak Berkenaan') {
                            countYa++; 
                        } else if (answer === 'TIDAK') { 
                            countTidak++; 
                        }
                    }
                });
            });

            const readinessScore = MAX_TOTAL_POINTS > 0 ? (totalPointsScored / MAX_TOTAL_POINTS) * 100 : 0;
            return { readinessScore: parseFloat(readinessScore.toFixed(2)), totalPointsScored, totalQuestions: MAX_TOTAL_POINTS, totalAnswered, totalScoredQuestions, answerBreakdown: { ya: countYa, tidak: countTidak, notAnswered: totalScoredQuestions - totalAnswered } };
        };
        
        window.getGeminiSummary = async (score) => {
            const answers = window.appState.answers;
            let status = '';
            if (score.readinessScore >= 80) { status = 'Bersedia'; } 
            else if (score.readinessScore >= 60) { status = 'Kurang Bersedia'; } 
            else { status = 'Tidak Bersedia'; }

            // Construct a simplified prompt
            let userQuery = `
                Analisis data penilaian kendiri Halal berikut:
                - Status Keseluruhan: ${status}
                - Skor Ketersediaan: ${score.readinessScore.toFixed(0)}%
                - Jumlah Mata: ${score.totalPointsScored} / ${score.totalQuestions}
                - Pecahan Jawapan: ${score.answerBreakdown.ya} YA, ${score.answerBreakdown.tidak} TIDAK
            `;
            
            // Add client's challenges if available
            if (answers.ulasan_cabaran_utama) {
                userQuery += `\n- Cabaran Utama Klien: ${answers.ulasan_cabaran_utama}`;
            }

            const systemPrompt = `Anda adalah Juruanalisis Pematuhan Halal. Berdasarkan data berikut, hasilkan ringkasan profesional dalam Bahasa Melayu. Ringkasan perlu merangkumi: 1. Status keseluruhan & skor. 2. Bahagian terkuat (jika ada). 3. Bahagian paling lemah yang memerlukan perhatian segera berdasarkan jawapan "TIDAK". 4. 1-2 nasihat kritikal. Format dalam satu perenggan padat, tanpa tajuk atau senarai.`;
            
            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };
            
            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) {
                    const errorBody = await response.json();
                    console.error("Gemini API error response:", errorBody);
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (text) {
                    return text;
                } else {
                    console.error("Invalid response structure from Gemini API:", result);
                    return "Gagal menjana ringkasan: Tiada kandungan diterima daripada AI.";
                }
            } catch (error) {
                console.error("Gemini API fetch error:", error);
                return "Gagal mendapatkan ringkasan AI akibat ralat teknikal. Sila cuba lagi.";
            }
        };


        window.renderGapsTable = (answers, scoredSections) => {
            let allGaps = [];
            const flowStepsMap = flowSteps.reduce((map, step) => {
                if (step.type === 'qa' || step.type === 'checklist') map[step.id] = step;
                return map;
            }, {});
            scoredSections.forEach(sectionId => {
                const questions = (sectionId === 'syarat') ? flowSteps.find(s => s.id === 'syarat').questions : qaQuestions[sectionId];
                const points = questionPoints[sectionId] || [];
                const secTitle = flowStepsMap[sectionId]?.title.replace(/^\d+\.\s*/, '') || 'Unknown';
                questions.forEach((q, index) => {
                    const answer = answers[`${sectionId}_${index}`];
                    let isGap = false;

                    if (sectionId === 'bahan' && index === 3) { // Inverted GAP logic for 'bahan' question 4
                        isGap = (answer === 'YA');
                    } else { // Default GAP logic for 'TIDAK'
                        isGap = (answer === 'TIDAK');
                    }

                    if (isGap) {
                        allGaps.push({ section: secTitle, question: q.replace(/\*/g, '').trim(), pointValue: points[index] || 0 });
                    }
                });
            });
            if (allGaps.length === 0) return '<p class="text-sm text-green-600 p-4 border rounded-lg bg-green-50">Tiada jurang kritikal dikesan.</p>';
            return `<div class="overflow-x-auto shadow-md rounded-lg"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Bahagian</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Soalan Jurang (GAP)</th><th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">Mata Hilang</th></tr></thead><tbody class="bg-white divide-y divide-gray-200">${allGaps.map(gap => `<tr class="hover:bg-red-50/50"><td class="px-6 py-4 text-sm font-medium text-red-700">${gap.section}</td><td class="px-6 py-4 text-sm">${gap.question}</td><td class="px-6 py-4 text-center text-sm font-bold text-red-600">${gap.pointValue}</td></tr>`).join('')}</tbody></table></div>`;
        };

        window.renderPieChart = (answerBreakdown, canvasTarget, onCompleteCallback = null) => {
            let canvasEl = typeof canvasTarget === 'string' ? document.getElementById(canvasTarget) : canvasTarget;

            if (!canvasEl) {
                if (onCompleteCallback) onCompleteCallback();
                return null;
            }
            
            const existingChart = Chart.getChart(canvasEl);
            if (existingChart) {
                existingChart.destroy();
            }
            
            return new Chart(canvasEl, {
                type: 'pie', data: { labels: ['YA (Halal Ready)', 'TIDAK (Perlu Tindakan)', 'Belum Dijawab'], datasets: [{ data: [answerBreakdown.ya, answerBreakdown.tidak, answerBreakdown.notAnswered], backgroundColor: ['#0d9488', '#dc2626', '#e5e7eb'], hoverOffset: 4 }] },
                options: { 
                    responsive: true, 
                    animation: {
                        onComplete: () => {
                            if (onCompleteCallback) {
                                onCompleteCallback();
                            }
                        }
                    },
                    plugins: { 
                        legend: { position: 'bottom', labels: { font: { family: 'Inter', size: 14 } } }, 
                        title: { display: true, text: 'Analisis Jawapan Keseluruhan', font: { size: 18, family: 'Inter', weight: 'bold' } } 
                    } 
                }
            });
        };

        window.updateAiSummaryDisplay = (summaryText) => {
            const container = document.getElementById('ai-summary-content');
            if (container) container.innerHTML = `<p class="text-gray-700">${summaryText}</p>`;
        };
        
        window.toggleModal = (show) => {
            const modal = document.getElementById('report-modal');
            if (modal) {
                modal.style.display = show ? 'flex' : 'none';
                if (show) {
                    const modalBody = document.getElementById('modal-report-body');
                    if (modalBody) {
                        modalBody.innerHTML = window.renderReportContent();
                        setTimeout(() => {
                            const score = window.calculateScore();
                            if (score.totalAnswered > 0) {
                                window.renderPieChart(score.answerBreakdown, 'modalReportPieChart');
                            }
                        }, 100);
                    }
                }
            }
        };

        window.printReport = async () => {
            const modalBody = document.getElementById('modal-report-body');
            if (!modalBody) return alert("Tiada laporan untuk dicetak.");

            // Ensure the report is fully rendered
            modalBody.innerHTML = window.renderReportContent();
            
            // Render the chart first
            const score = window.calculateScore();
            if (score.totalAnswered > 0) {
                await new Promise((resolve) => {
                    window.renderPieChart(score.answerBreakdown, 'modalReportPieChart', resolve);
                });
            }

            // Wait a moment for the browser to draw all elements
            await new Promise(r => setTimeout(r, 400));

            // Now call the print function
            window.print();
        };

        window.downloadReportPDF = async () => {
            const reportElement = document.getElementById('modal-report-body');
            if (!reportElement) {
                alert("Ralat: Elemen laporan tidak ditemui untuk dimuat turun.");
                return;
            }

            const downloadButton = document.querySelector('button[onclick="window.downloadReportPDF()"]');
            const originalButtonText = downloadButton.innerHTML;
            downloadButton.innerHTML = '<span class="animate-pulse">Menjana PDF...</span>';
            downloadButton.disabled = true;

            // Ensure the content is fresh and the chart is rendered
            reportElement.innerHTML = window.renderReportContent();
            const score = window.calculateScore();
            if (score.totalAnswered > 0) {
                await new Promise(resolve => window.renderPieChart(score.answerBreakdown, 'modalReportPieChart', resolve));
            }
            
            // Wait for DOM to update
            await new Promise(r => setTimeout(r, 500));
            
            const clientName = window.appState.answers['nama_perniagaan'] || 'laporan-ehalalgap';
            const filename = `${clientName.replace(/\s+/g, '_').toLowerCase()}_${new Date().toISOString().slice(0,10)}.pdf`;

            const { jsPDF } = window.jspdf;

            html2canvas(reportElement.querySelector('#pdf-content-container'), {
                scale: 2, // Higher scale for better quality
                useCORS: true
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/jpeg', 0.95);
                const pdf = new jsPDF('p', 'mm', 'a4');
                
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();
                
                const canvasWidth = canvas.width;
                const canvasHeight = canvas.height;
                
                const ratio = canvasHeight / canvasWidth;
                
                const imgWidth = pdfWidth - 20; // 10mm margin on each side
                const imgHeight = imgWidth * ratio;
                
                let heightLeft = imgHeight;
                let position = 10; // Initial top margin

                pdf.addImage(imgData, 'JPEG', 10, position, imgWidth, imgHeight);
                heightLeft -= (pdfHeight - 20);

                while (heightLeft > 0) {
                    position -= (pdfHeight - 20);
                    pdf.addPage();
                    pdf.addImage(imgData, 'JPEG', 10, position, imgWidth, imgHeight);
                    heightLeft -= (pdfHeight - 20);
                }

                pdf.save(filename);

                // Restore button state
                downloadButton.innerHTML = originalButtonText;
                downloadButton.disabled = false;
            }).catch(err => {
                console.error("Error generating PDF:", err);
                alert("Gagal menjana PDF. Sila lihat konsol untuk ralat.");
                // Restore button state
                downloadButton.innerHTML = originalButtonText;
                downloadButton.disabled = false;
            });
        };

        window.renderLogin = () => {
            const isRegister = window.appState.isRegisterMode;
            return `<div class="h-screen flex items-center justify-center p-4"><div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-md"><h1 class="text-3xl font-bold mb-6 text-center text-gray-800">${isRegister ? 'Daftar Akaun Baharu' : 'Log Masuk Klien'}</h1><div class="space-y-4"><input type="email" id="email" placeholder="Alamat Emel" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500" /><input type="password" id="password" placeholder="Kata Laluan (Min 6 Aksara)" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500" /><p id="auth-error-message" class="text-sm text-red-500 text-center"></p><button onclick="window.handleAuth(${isRegister})" class="w-full btn-primary py-3 rounded-xl text-white font-semibold shadow-md hover:shadow-lg">${isRegister ? 'Daftar Sekarang' : 'Log Masuk'}</button><p class="text-center text-sm mt-4">${isRegister ? `Sudah ada akaun? <a href="#" onclick="window.updateState({ isRegisterMode: false })" class="text-teal-600 hover:text-teal-800 font-semibold">Log Masuk di sini</a>` : `Belum mendaftar? <a href="#" onclick="window.updateState({ isRegisterMode: true })" class="text-teal-600 hover:text-teal-800 font-semibold">Daftar Akaun Baharu</a>`}</p></div><p class="mt-6 text-xs text-center"><a href="index.html" class="text-teal-600 hover:text-teal-800 font-medium">&larr; Kembali ke Halaman Utama</a></p></div></div>`;
        };

        window.renderProgress = (score) => {
            const progressAnswered = (score.totalScoredQuestions > 0 ? (score.totalAnswered / score.totalScoredQuestions) * 100 : 0).toFixed(0);
            return `<div class="mb-8 p-6 bg-white rounded-xl shadow-lg border-l-4 border-teal-500"><h3 class="text-xl font-semibold mb-4 text-gray-800">Kemajuan Penilaian</h3><div class="bg-blue-50 border-l-4 border-blue-400 text-blue-700 p-4 mb-6 rounded-lg" role="alert"><p class="font-bold">Nota Penting:</p><p class="text-sm">Sila jawab semua soalan dengan jujur. Penilaian ini bertujuan untuk mengenal pasti jurang (GAP) sebenar perniagaan anda.</p></div><div class="flex flex-col items-center justify-center"><div class="flex flex-col items-center"><div class="progress-ring" style="--progress: ${progressAnswered}%;"><div class="progress-ring-inner">${progressAnswered}%</div></div><p class="mt-4 text-lg font-medium">Soalan Dijawab</p><p class="mt-1 text-sm text-gray-500">(${score.totalAnswered} dari ${score.totalScoredQuestions} soalan)</p></div></div></div>`;
        };

        window.renderTabContent = () => {
            const step = flowSteps[window.appState.currentStep];
            const currentAnswers = window.appState.answers;
            let html = `<h2 class="text-2xl font-bold mb-2">${step.title}</h2><p class="text-md text-gray-600 mb-6">${step.description}</p>`;
            
            if (step.id === 'syarat') {
                html += '<div class="space-y-6">';
                step.questions.forEach((question, index) => {
                    const id = `${step.id}_${index}`;
                    const answer = currentAnswers[id] || '';
                    let options = ['YA', 'TIDAK'];
                    if (index === 3 || index === 4) {
                        options.push('Tidak Berkenaan');
                    }
                    html += `<div class="bg-white p-5 rounded-xl shadow-lg border-t-4 border-teal-500/50"><p class="font-medium mb-3">${index + 1}. ${question}</p><div class="flex flex-wrap gap-3">${options.map(option => `<button onclick="window.handleAnswer('${id}', '${option}', true)" class="px-5 py-2 rounded-full text-sm font-semibold transition ${answer === option ? 'bg-teal-600 text-white shadow-md' : 'bg-gray-100 hover:bg-teal-100'}">${option}</button>`).join('')}</div></div>`;
                });
                html += '</div>';

                // Add footnotes for FoSIM and NPRA
                html += `
                    <div class="mt-8 pt-4 border-t border-gray-200 text-sm text-gray-600 space-y-2">
                        <p><strong>* FoSIM:</strong> (Food Safety Information System of Malaysia) - Sistem pendaftaran premis makanan online di bawah Kementerian Kesihatan Malaysia (KKM).</p>
                        <p><strong>* NPRA:</strong> (National Pharmaceutical Regulatory Agency) - Agensi Regulatori Farmasi Negara, bertanggungjawab untuk pendaftaran produk kosmetik dan farmaseutikal di Malaysia.</p>
                    </div>
                `;
            }
            else if (step.type === 'checklist' || step.type === 'qa') {
                const questions = step.type === 'checklist' ? step.questions : qaQuestions[step.id];
                html += '<div class="space-y-6">';
                questions.forEach((question, index) => {
                    const id = `${step.id}_${index}`;
                    const answer = currentAnswers[id] || '';
                    let options = ['YA', 'TIDAK'];
                    if (step.id === 'bahan' && index === 1) {
                        options.push('Tidak Berkenaan');
                    }
                    html += `<div class="bg-white p-5 rounded-xl shadow-lg border-t-4 border-teal-500/50"><p class="font-medium mb-3">${index + 1}. ${question}</p><div class="flex flex-wrap gap-3">${options.map(option => `<button onclick="window.handleAnswer('${id}', '${option}', true)" class="px-5 py-2 rounded-full text-sm font-semibold transition ${answer === option ? 'bg-teal-600 text-white shadow-md' : 'bg-gray-100 hover:bg-teal-100'}">${option}</button>`).join('')}</div></div>`;
                });
                html += '</div>';
            } else if (step.type === 'selection') {
                 html += '<div class="space-y-4">';
                step.options.forEach((question, index) => {
                    const id = `${step.id}_${index}`;
                    const isChecked = currentAnswers[id] === 'YA';

                    let isDisabled = false;
                    let labelClasses = "flex items-start p-4 bg-white rounded-xl shadow-sm hover:shadow-md cursor-pointer transition duration-150 w-full";
                    let inputAttributes = `type="radio" name="${step.id}" id="${id}" value="YA" ${isChecked ? 'checked' : ''} onchange="window.handleAnswer('${id}', 'YA', true)" class="mt-1 h-5 w-5 text-teal-600 border-gray-300 rounded focus:ring-2 focus:ring-teal-500 flex-shrink-0"`;
                    let spanClasses = "ml-3 text-gray-700";
                    let disabledText = '';
                    
                    if (step.id === 'kategori' && (index === 2 || index === 3)) {
                        isDisabled = true;
                        labelClasses = "flex items-start p-4 bg-gray-100 rounded-xl shadow-sm cursor-not-allowed transition duration-150 w-full opacity-60";
                        inputAttributes = `type="radio" name="${step.id}" id="${id}" value="YA" disabled class="mt-1 h-5 w-5 text-gray-400 border-gray-300 rounded flex-shrink-0"`;
                        spanClasses = "ml-3 text-gray-500";
                        disabledText = '<span class="ml-2 text-xs font-semibold text-gray-500">(Tidak Aktif)</span>';
                    }
                    
                    if (step.id === 'skim' && ![0, 1, 3, 4].includes(index)) { // If index is NOT 0, 1, 3, or 4
                         isDisabled = true;
                        labelClasses = "flex items-start p-4 bg-gray-100 rounded-xl shadow-sm cursor-not-allowed transition duration-150 w-full opacity-60";
                        inputAttributes = `type="radio" name="${step.id}" id="${id}" value="YA" disabled class="mt-1 h-5 w-5 text-gray-400 border-gray-300 rounded flex-shrink-0"`;
                        spanClasses = "ml-3 text-gray-500";
                        disabledText = '<span class="ml-2 text-xs font-semibold text-gray-500">(Akan Datang)</span>';
                    }


                    html += `
                        <label for="${id}" class="${labelClasses}">
                            <input ${inputAttributes}>
                            <span class="${spanClasses}">${question}${disabledText}</span>
                        </label>
                    `;
                });
                html += '</div>';
            } else if (step.type === 'form') {
                const fields = ['Nama Perniagaan', 'No SSM (jika ada)', 'Alamat', 'No Telefon', 'Nama Pemilik', 'Jualan tahunan perniagaan', 'Bilangan pekerja keseluruhan'];
                const mandatoryFields = ['Nama Perniagaan', 'No SSM (jika ada)', 'Alamat', 'No Telefon'];
                html += '<div class="space-y-6 bg-white p-6 rounded-xl shadow-lg">';
                fields.forEach(field => {
                    const id = field.toLowerCase().replace(/[^a-z0-9]/g, '_').replace(/_+/g, '_');
                    const value = currentAnswers[id] || '';
                    const isNumber = field.includes('Jualan') || field.includes('Bilangan');
                    html += `<div><label for="${id}" class="block text-sm font-medium mb-1">${field} ${mandatoryFields.includes(field) ? '<span class="text-red-500">*</span>' : ''}</label><input type="${isNumber ? 'number' : 'text'}" id="${id}" value="${value}" onchange="window.handleAnswer('${id}', this.value, false)" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-teal-500" placeholder="${field}"></div>`;
                });
                html += '</div>';
            } else if (step.type === 'textarea') {
                const id = 'ulasan_cabaran_utama';
                const value = currentAnswers[id] || '';
                html += `<div class="bg-white p-6 rounded-xl shadow-lg"><div><label for="${id}" class="block text-base font-medium mb-3">Apakah cabaran utama yang tuan/puan hadapi dalam memenuhi keperluan halal?</label><textarea id="${id}" onchange="window.handleAnswer('${id}', this.value, false)" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-teal-500" rows="10" placeholder="Sila nyatakan cabaran anda...">${value}</textarea></div></div>`;
            } else if (step.type === 'result') {
                const score = window.calculateScore();
                html += window.renderReportSummary(score);
                html += `<div class="mt-8 flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-4"><button onclick="window.toggleModal(true)" class="btn-primary text-white px-8 py-4 rounded-xl font-semibold shadow-lg hover:shadow-xl inline-flex items-center">Preview Laporan Penuh</button></div><div class="mt-8 pt-4 border-t"><p class="text-xs text-gray-500 italic font-semibold">Notis Penafian:</p><p class="text-xs mt-1">Laporan ini disediakan berdasarkan penilaian kendiri. Ia hanyalah untuk rujukan dan tidak boleh dianggap sebagai bukti rasmi.</p></div>`;
                setTimeout(() => {
                    if (score.totalAnswered > 0 && !window.appState.answers.aiSummary) { // Only generate if not already present
                        window.renderPieChart(score.answerBreakdown, 'reportPieChart');
                        window.getGeminiSummary(score).then(summary => {
                            window.updateState({ answers: { ...window.appState.answers, aiSummary: summary } });
                        });
                    } else if(score.totalAnswered > 0) {
                         window.renderPieChart(score.answerBreakdown, 'reportPieChart');
                         window.updateAiSummaryDisplay(window.appState.answers.aiSummary);
                    }
                }, 100);
            }
            return html;
        };

        window.renderReportSummary = (score) => {
            const progress = score.readinessScore;
            let status = '', statusColor = '', recommendation = '';
            if (progress >= 80) { status = 'Bersedia'; statusColor = 'bg-green-100 text-green-700 border-green-500'; recommendation = 'Tahniah! Perniagaan anda menunjukkan ketersediaan tinggi.'; }
            else if (progress >= 60) { status = 'Kurang Bersedia'; statusColor = 'bg-yellow-100 text-yellow-700 border-yellow-500'; recommendation = 'Perniagaan anda di tahap sederhana. Fokus pada jawapan "TIDAK".'; }
            else { status = 'Tidak Bersedia'; statusColor = 'bg-red-100 text-red-700 border-red-500'; recommendation = 'Perniagaan anda memerlukan penambahbaikan signifikan.'; }
            
            let aiSummaryHtml = '<p class="animate-pulse text-teal-600">AI sedang menganalisis data...</p>';
            if(window.appState.answers.aiSummary){
                aiSummaryHtml = `<p class="text-gray-700">${window.appState.answers.aiSummary}</p>`;
            }

            return `<div class="space-y-8"><div class="p-6 rounded-xl shadow-lg border"><h3 class="text-2xl font-bold mb-4 text-center">Ringkasan Keputusan</h3><div class="flex flex-col sm:flex-row items-center justify-around text-center space-y-4 sm:space-y-0"><div><p class="text-5xl font-extrabold text-teal-600">${progress.toFixed(0)}%</p><p class="text-xl mt-1">Peratus Ketersediaan</p></div><div><p class="text-5xl font-extrabold">${score.totalPointsScored}/${score.totalQuestions}</p><p class="text-xl mt-1">Mata Halal Diperolehi</p></div></div></div><div class="text-center p-6 rounded-xl border-4 ${statusColor} shadow-md"><p class="text-2xl font-bold">Status: <span class="text-3xl">${status.toUpperCase()}</span></p><p class="mt-4">${recommendation}</p></div><div class="p-6 bg-teal-50 rounded-xl shadow-lg border-l-4 border-teal-600"><h4 class="text-xl font-semibold mb-2">Rumusan Analisis AI</h4><p class="text-xs text-gray-500 italic mb-3">*Ringkasan ini dijana oleh AI dan bertujuan sebagai panduan awal sahaja.</p><div id="ai-summary-content" class="text-base">${aiSummaryHtml}</div></div><div class="p-6 bg-white rounded-xl shadow-lg"><h4 class="text-xl font-semibold mb-6 border-b pb-2">Analisis Jawapan</h4><div class="flex justify-center w-full max-w-lg mx-auto"><canvas id="reportPieChart" width="400" height="400"></canvas></div></div></div>`;
        };

        window.renderReportContent = () => {
            const score = window.calculateScore();
            const progress = score.readinessScore;
            const answers = window.appState.answers;
            const clientIdentifier = answers.nama_perniagaan || (window.auth.currentUser ? window.auth.currentUser.email : window.appState.userId);
            const scoredSections = ['syarat', 'premis', 'bahan', 'sanitasi', 'pekerja', 'dokumentasi'];
            let status = '', statusColor = '', recommendation = '';
            if (progress >= 80) { status = 'Bersedia'; statusColor = 'bg-green-100 text-green-700 border-green-500'; recommendation = 'Tahniah! Perniagaan anda menunjukkan ketersediaan tinggi.'; } 
            else if (progress >= 60) { status = 'Kurang Bersedia'; statusColor = 'bg-yellow-100 text-yellow-700 border-yellow-500'; recommendation = 'Perniagaan anda di tahap sederhana. Fokus pada jawapan "TIDAK".'; } 
            else { status = 'Tidak Bersedia'; statusColor = 'bg-red-100 text-red-700 border-red-500'; recommendation = 'Perniagaan anda memerlukan penambahbaikan signifikan.'; }
            const clientReview = answers['ulasan_cabaran_utama'];
            const aiSummary = answers.aiSummary || 'Rumusan AI belum dijana.';

            return `<div id="pdf-content-container" class="bg-white p-8">
                        <!-- Section 1: Header & Summary -->
                        <div class="text-center pb-4 border-b">
                            <h2 class="text-3xl font-extrabold text-gray-800">eHalal<span class="text-teal-600">GAP</span></h2>
                            <h1 class="text-2xl font-bold text-gray-700 mt-2">Laporan Semakan Jurang Halal</h1>
                            <p class="text-lg text-gray-500 mt-1">${clientIdentifier}</p>
                        </div>
                        <div class="mt-8 p-6 rounded-xl shadow-lg border"><h3 class="text-2xl font-bold mb-4 text-center">Ringkasan Keputusan</h3><div class="flex flex-col sm:flex-row items-center justify-around text-center"><div><p class="text-5xl font-extrabold text-teal-600">${progress.toFixed(0)}%</p><p class="text-xl mt-1">Ketersediaan</p></div><div><p class="text-5xl font-extrabold">${score.totalPointsScored}/${score.totalQuestions}</p><p class="text-xl mt-1">Mata Halal</p></div></div></div>
                        <div class="mt-8 text-center p-6 rounded-xl border-4 ${statusColor} shadow-md"><p class="text-2xl font-bold">Status: <span class="text-3xl">${status.toUpperCase()}</span></p><p class="mt-4">${recommendation}</p></div>

                        <!-- Section 2: AI & Business Info -->
                        <div class="mt-8 p-6 bg-teal-50 rounded-xl shadow-lg border-l-4 border-teal-600"><h4 class="text-xl font-semibold mb-2">Rumusan Analisis AI</h4><p class="text-xs text-gray-500 italic mb-3">*Ringkasan ini dijana oleh AI dan bertujuan sebagai panduan awal sahaja.</p><div class="text-base">${aiSummary}</div></div>
                        <div class="mt-8 p-6 bg-gray-50 rounded-xl shadow-sm border"><h4 class="text-xl font-semibold mb-4 border-b pb-2">Maklumat Perniagaan</h4><div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm font-bold">${['Nama Perniagaan','No SSM (jika ada)','Alamat','No Telefon','Nama Pemilik','Jualan tahunan perniagaan','Bilangan pekerja keseluruhan'].map(f => `<p><strong>${f}:</strong> ${answers[f.toLowerCase().replace(/[^a-z0-9]/g,'_').replace(/_+/g,'_')] || '- '}</p>`).join('')}</div></div>
                        ${clientReview ? `<div class="mt-8 p-6 bg-gray-50 rounded-xl shadow-sm border"><h4 class="text-xl font-semibold mb-4 border-b pb-2">Ulasan Klien</h4><p class="text-sm whitespace-pre-wrap">${clientReview}</p></div>` : ''}

                        <!-- Section 3: Pie Chart -->
                        <div class="mt-8 p-6 bg-white rounded-xl shadow-lg"><h4 class="text-xl font-semibold mb-6 border-b pb-2">Analisis Jawapan</h4><div class="flex justify-center w-full max-w-lg mx-auto"><canvas id="modalReportPieChart" width="400" height="400"></canvas></div></div>

                        <!-- Section 4: Gaps Table -->
                        <div class="mt-8 p-6 bg-white rounded-xl shadow-lg border-t-4 border-red-500"><h4 class="text-xl font-bold text-red-700 mb-4 border-b pb-2">Jurang Pematuhan Kritikal</h4>${window.renderGapsTable(answers, scoredSections)}</div>

                        <!-- Section 5: Section Analysis -->
                        <div class="mt-8 p-6 bg-white rounded-xl shadow-lg"><h4 class="text-xl font-semibold mb-6 border-b pb-2">Analisis Mengikut Bahagian</h4>${scoredSections.map(sId => { const qs = (sId === 'syarat') ? flowSteps.find(s=>s.id===sId).questions : qaQuestions[sId]; const pts = questionPoints[sId] || []; let secMax=0, secScore=0; pts.forEach(p=>{secMax+=p;}); qs.forEach((q,idx) => { const ans = answers[`${sId}_${idx}`]; let isReady= (ans==='YA'); if(sId==='bahan'&& idx===3) isReady=(ans==='TIDAK'); if(isReady) secScore+=pts[idx]; }); const secPerc = secMax > 0 ? (secScore / secMax) * 100 : 0; const secTitle = flowSteps.find(s=>s.id===sId)?.title.replace(/^\d+\.\s*/, '') || sId; const barColor = secPerc >= 80 ? 'bg-green-500' : secPerc >= 60 ? 'bg-yellow-500' : 'bg-red-500'; return `<div class="mb-6 border-b pb-4"><h5 class="text-lg font-bold">${secTitle}</h5><div class="flex justify-between items-center mb-1"><span class="text-sm">Skor: ${secScore}/${secMax}</span><span class="text-lg font-bold">${secPerc.toFixed(0)}%</span></div><div class="w-full bg-gray-200 rounded-full h-3"><div class="${barColor} h-3 rounded-full" style="width: ${secPerc.toFixed(0)}%"></div></div></div>`; }).join('')}</div>
                        
                        <!-- Footer -->
                        <div class="mt-8 text-xs text-gray-500 text-center pt-4 border-t">&copy; Hak Cipta ACE UniKL MICET 2025.</div>
                    </div>`;
        };

        window.handleAnswer = (key, value, shouldRender) => {
            let sanitizedValue = (typeof value === 'string') ? value.trim() : value;
            let newAnswers = { ...window.appState.answers, [key]: sanitizedValue };
            const currentStep = flowSteps[window.appState.currentStep];
            if (currentStep.type === 'selection' && value === 'YA') {
                currentStep.options.forEach((_, index) => {
                    const id = `${currentStep.id}_${index}`;
                    if (id !== key && newAnswers[id] === 'YA') delete newAnswers[id];
                });
            }
            
            if (shouldRender) {
                window.updateState({ answers: newAnswers });
            } else {
                updateStateAndSave({ answers: newAnswers });
            }
        };

        window.goToStep = (index) => {
            const resultStepIndex = flowSteps.findIndex(step => step.id === 'result');
            if (index === resultStepIndex && !window.appState.assessmentCompleted) {
                console.log("Sila lengkapkan penilaian sebelum melihat laporan.");
                return; 
            }

            if (index >= 0 && index < flowSteps.length) {
                window.updateState({ currentStep: index });
            }
        };

        window.changeStep = async (direction) => {
            const currentStepIndex = window.appState.currentStep;
            const newStepIndex = currentStepIndex + direction;
            const isUlasanStep = flowSteps[currentStepIndex].id === 'ulasan';

            if (isUlasanStep && direction > 0) {
                document.getElementById('ai-summary-content').innerHTML = '<p class="animate-pulse text-teal-600">AI sedang menganalisis data...</p>';
                const score = window.calculateScore();
                const summary = await getGeminiSummary(score);
                await updateStateAndSave({ 
                    currentStep: newStepIndex, 
                    assessmentCompleted: true, 
                    answers: { ...window.appState.answers, aiSummary: summary } 
                });
                window.renderApp();
            } else if (newStepIndex >= 0 && newStepIndex < flowSteps.length) {
                window.updateState({ currentStep: newStepIndex });
            }
        };

        window.renderApp = () => {
            const appContainer = document.getElementById('app-container');
            if (!window.appState.authReady || !window.appState.isAuthenticated) {
                appContainer.innerHTML = window.renderLogin();
                return;
            }
            const currentStepIndex = window.appState.currentStep;
            const score = window.calculateScore(); 
            const isUlasanStep = flowSteps[currentStepIndex].id === 'ulasan';
            const isResultStep = flowSteps[currentStepIndex].id === 'result';
            const nextButtonText = isUlasanStep ? 'Hantar Penilaian' : 'Seterusnya';

            const introductionHtml = `<div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 w-full"><div class="mb-8 p-6 bg-white rounded-xl shadow-lg border-l-4 border-teal-500"><h3 class="text-xl font-semibold mb-2">Mengapa eHalalGAP?</h3><p class="text-base leading-relaxed">e-HalalGAP membantu anda menjejaki ketersediaan, menggambarkan kemajuan, dan mengurus dokumentasi di satu tempat, memudahkan kerjasama dengan perunding anda.</p></div></div>`;
            appContainer.innerHTML = `<div class="min-h-screen bg-gray-50 flex flex-col"><header class="hero-bg py-4 px-4 shadow-lg"><div class="max-w-6xl mx-auto text-white flex justify-between items-center"><div><h1 class="text-xl sm:text-2xl font-extrabold">Semakan Jurang Halal (eHalalGAP)</h1><p class="mt-1 text-sm text-gray-200">Analisis Kendiri untuk Pensijilan Halal</p></div><button onclick="window.logoutClient()" class="bg-red-500 text-white hover:bg-red-600 px-4 py-2 rounded-lg text-sm font-semibold flex items-center"><svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>Log Keluar</button></div></header><main class="flex-grow max-w-6xl mx-auto py-8 w-full">${introductionHtml}<div class="px-4 sm:px-6 lg:px-8" id="main-content-start">${window.renderProgress(score)}<nav class="flex overflow-x-auto whitespace-nowrap space-x-2 sm:space-x-4 mb-8 p-1 bg-white rounded-xl shadow-md" id="tab-nav-container">${flowSteps.map((step, index) => {
                const isResultTab = step.id === 'result';
                const isCompleted = window.appState.assessmentCompleted;
                let tabClasses = 'py-3 px-3 sm:px-4 text-sm font-medium transition rounded-lg';
                if (isResultTab && !isCompleted) {
                    tabClasses += ' cursor-not-allowed text-gray-400 bg-gray-50';
                } else {
                    tabClasses += ` cursor-pointer ${index === currentStepIndex ? 'tab-active bg-teal-50' : 'text-gray-600 hover:bg-gray-100'}`;
                }
                return `<button onclick="window.goToStep(${index})" class="${tabClasses}">${step.title.replace(/^\d+\.\s*/, '')}</button>`;
            }).join('')}</nav><div class="p-6 bg-white rounded-xl shadow-2xl border-t-4 border-teal-500">${window.renderTabContent()}</div><div class="mt-8 flex flex-col sm:flex-row sm:justify-between sm:items-center space-y-4 sm:space-y-0"><button onclick="window.changeStep(-1)" ${currentStepIndex === 0 ? 'disabled' : ''} class="w-full sm:w-auto btn-secondary px-6 py-3 rounded-xl font-semibold disabled:opacity-50 flex items-center justify-center"><svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>Sebelumnya</button><div class="flex flex-col items-center space-y-2 w-full sm:w-auto"><button onclick="window.manualSave()" ${isResultStep ? 'disabled' : ''} id="save-progress-btn" class="w-full sm:w-auto inline-flex items-center justify-center btn-secondary px-6 py-3 rounded-xl font-semibold hover:bg-teal-100 text-teal-700 disabled:opacity-50"><svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path></svg>Simpan Kemajuan</button><p id="save-status-message" class="text-xs text-gray-500 opacity-0 transition"></p></div><button onclick="window.changeStep(1)" ${isResultStep ? 'disabled' : ''} class="w-full sm:w-auto btn-primary px-6 py-3 rounded-xl text-white font-semibold disabled:opacity-50 flex items-center justify-center">${nextButtonText}<svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg></button></div></div></main><footer class="bg-gray-800 text-white p-4 mt-8"><div class="max-w-6xl mx-auto text-center text-sm"><p>&copy; Hak Cipta ACE UniKL MICET 2025.</p></div></footer></div><div id="report-modal" class="modal"><div class="modal-content"><div class="sticky top-0 bg-white border-b p-4 flex justify-between items-center rounded-t-xl z-10 print-hidden"><h2 class="text-2xl font-bold">Preview Laporan Penuh</h2><button onclick="window.toggleModal(false)" class="text-gray-500 hover:text-gray-800"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button></div><div id="modal-report-body"></div><div class="sticky bottom-0 bg-gray-50 border-t p-4 flex justify-center rounded-b-xl z-10 space-x-4 print-hidden"><button onclick="window.toggleModal(false)" class="btn-secondary px-6 py-3 rounded-xl font-semibold">Tutup</button><button onclick="window.printReport()" class="btn-secondary px-6 py-3 rounded-xl font-semibold">Cetak Laporan</button><button onclick="window.downloadReportPDF()" class="btn-primary px-6 py-3 rounded-xl text-white font-semibold">Muat Turun PDF</button></div></div></div>`;
        };
    </script>
</head>
<body>
    <div id="app-container">
        <div class="h-screen flex items-center justify-center">
            <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-teal-500"></div>
            <p class="ml-4 text-teal-600">Memuatkan Aplikasi...</p>
        </div>
    </div>
</body>
</html>

