<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Semakan Jurang Halal (eHalalGAP)</title>
    <!-- Favicon Links -->
    <link rel="apple-touch-icon" sizes="180x180" href="https://raw.githubusercontent.com/goldigger79/eHalalGAP/main/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://raw.githubusercontent.com/goldigger79/eHalalGAP/main/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://raw.githubusercontent.com/goldigger79/eHalalGAP/main/favicon-16x16.png">
    <link rel="manifest" href="https://raw.githubusercontent.com/goldigger79/eHalalGAP/main/site.webmanifest">
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Libraries for PDF Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Load Chart.js for visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        /* Custom styles for professional look and font */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        .hero-bg {
            background-color: #1a4f78; /* Deep professional blue */
        }
        .btn-primary {
            background-color: #0d9488; /* Teal/Turquoise for action */
            transition: background-color 0.3s;
        }
        .btn-primary:hover {
            background-color: #0f766e;
        }
        .btn-secondary {
            background-color: #e5e7eb;
            color: #374151;
            transition: background-color 0.3s;
        }
        .btn-secondary:hover {
            background-color: #d1d5db;
        }
        .tab-active {
            border-bottom: 4px solid #0d9488;
            color: #0d9488;
            font-weight: 600;
        }
        /* Custom CSS for Progress Bar (Doughnut Chart Style) */
        .progress-ring {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: conic-gradient(#0d9488 0%, #0d9488 var(--progress), #e5e7eb var(--progress), #e5e7eb 100%);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .progress-ring-inner {
            width: 90px;
            height: 90px;
            background-color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: 700;
            color: #0d9488;
        }
        /* Style for PDF container to ensure clean output */
        #pdf-content-container {
            background-color: white;
            color: black;
            font-family: 'Inter', sans-serif;
        }
        /* New custom CSS for unconstrained logo size, ensuring responsiveness */
        .logo-img {
            max-width: 100%; /* Ensures it scales down on mobile if too large */
            height: auto;
            display: block;
        }
        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 50;
            overflow-y: auto;
            padding: 20px;
        }
        .modal-content {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            width: 95%;
            max-width: 1200px;
            max-height: 95vh;
            overflow-y: auto;
            position: relative;
        }
    </style>
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, createUserWithEmailAndPassword, signInWithEmailAndPassword, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, setLogLevel, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL FIREBASE VARIABLES (MANDATORY USE) ---
        const APP_FIREBASE_CONFIG = {
            apiKey: "AIzaSyCll1mrRqrAMAUqzdGqSYSyFBiOpb6y_y4",
            authDomain: "ehalalgap.firebaseapp.com",
            projectId: "ehalalgap",
            storageBucket: "ehalalgap.firebasestorage.app",
            appId: "1:687151615169:web:8ff94f1eed2c6d1d5f1840",
            measurementId: "G-6QBXVD6R0R"
        };
        
        const appId = APP_FIREBASE_CONFIG.projectId;
        const firebaseConfig = APP_FIREBASE_CONFIG;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null; 
        
        let app = null;
        window.db = null;
        window.auth = null;

        window.appState = {
            isAuthenticated: false,
            authReady: false,
            userId: null,
            currentStep: 0,
            answers: {},
            isPaidClient: false, 
            isRegisterMode: false,
            assessmentCompleted: false, // <-- Kunci utama untuk logik lockdown
            aiSummary: null // For saved AI summary
        };
        
        // UPDATED a new flowSteps
        const flowSteps = [
            { id: 'maklumat', title: '1. Maklumat Perniagaan', type: 'form', description: 'Sila isikan maklumat asas perniagaan anda.'},
            { id: 'kategori', title: '2. Kategori Industri', type: 'selection', description: 'Sila pilih **salah satu** kategori industri perniagaan anda.', options: ['Mikro (Jualan Tahunan < RM300,000 ATAU Pekerja < 5 orang)', 'Kecil (Jualan Tahunan RM300,000 - RM 15 juta ATAU Pekerja 5 - 75 orang)', 'Sederhana (Jualan Tahunan RM 15 juta - RM 50 juta ATAU Pekerja 75 - 200 orang)', 'Besar (Jualan Tahunan > RM 50 juta ATAU Pekerja > 200 orang)']},
            { id: 'skim', title: '3. Skim Pensijilan', type: 'selection', description: 'Sila pilih **salah satu** skim pensijilan Halal yang berkaitan dengan jenis perniagaan anda.', options: ['Produk Makanan dan Minuman', 'Produk Kosmetik', 'Produk Farmaseutikal', 'Premis Makanan', 'Produk Barang Gunaan', 'Perkhidmatan Logistik', 'Rumah Sembelihan', 'Pengilangan Kontrak/OEM', 'Produk Peranti Perubatan']},
            { id: 'syarat', title: '4. Umum', type: 'checklist', description: 'Sila semak sama ada perniagaan anda memenuhi syarat-syarat asas ini.', questions: ["Adakah perniagaan berdaftar dengan Suruhanjaya Perniagaan Malaysia (SSM)?", "Adakah perniagaan Telah beroperasi sepenuhnya sekurang-kurangnya 3 bulan?", "Adakah perniagaan Memiliki lesen atau kelulusan daripada PBT?", "Jika premis makanan, adakah telah mendapat perakuan FOSIM? *", "Jika skim kosmetik, adakah telah mendapat perakuan NPRA? *"]},
            { id: 'premis', title: '5. Premis', type: 'qa', description: 'Soalan berkaitan lokasi, struktur, dan pelan lantai premis.'},
            { id: 'bahan', title: '6. Bahan Mentah & Peralatan', type: 'qa', description: 'Soalan berkaitan bahan mentah, penyimpanan, dan peralatan.'},
            { id: 'sanitasi', title: '7. Sanitasi', type: 'qa', description: 'Soalan berkaitan kebersihan dan kawalan makhluk perosak.'},
            { id: 'pekerja', title: '8. Pekerja', type: 'qa', description: 'Soalan berkaitan pekerja dan latihan halal.'},
            { id: 'dokumentasi', title: '9. Dokumentasi & Rekod', type: 'qa', description: 'Soalan berkaitan sistem dokumentasi dan rekod perniagaan.'},
            { id: 'ulasan', title: '10. Ulasan', type: 'textarea', description: 'Sila kongsikan pandangan dan cabaran utama anda.' },
            { id: 'result', title: '11. Keputusan & Laporan', type: 'result', description: 'Laporan Ketersediaan Halal JAKIM anda.' }
        ];

        const qaQuestions = {
            premis: ["Adakah premis anda terletak jauh dari dan tidak dicemari oleh ladang babi atau aktiviti pemprosesan tidak halal?","Adakah premis bebas daripada bahan mentah dan produk tidak halal seperti arak dan daging babi?","Adakah premis mempunyai mekanisme pengawalan bagi mencegah haiwan peliharaan atau liar, serangga dan haiwan perosak daripada memasuki atau berada di dalam kawasan premis?","Adakah premis dalam keadaan baik, bersih dan kemas?","Adakah lantai, dinding, siling, kipas, penghawa dingin, tingkap dan pintu berkeadaan bersih dan tidak menyumbang kepada pencemaran?","Adakah anda menggunakan bekalan air terawat (portable water) daripada Jabatan/Syarikat Bekalan Air?","Adakah ruang simpanan bahan mentah dipisahkan daripada ruang simpanan produk siap?","Adakah terdapat kemudahan sinki untuk basuh tangan yang dilengkapi dengan sabun dan tuala pakai buang/pengering tangan?","Adakah lantai diperbuat daripada bahan kalis air, tidak menyerap dan mudah dibersihkan?","Adakah terdapat sistem saliran air yang baik pada lantai pemprosesan?","Adakah dinding premis licin, kalis air, dan mudah dicuci?","Adakah siling atau bahagian atas premis direka untuk elak habuk jatuh, kulapuk dan titisan air?","Adakah pintu premis diperbuat daripada bahan kalis air, mudah dibersihkan, dan ditutup secara kendiri?","Adakah tingkap yang boleh dibuka dilengkapi dengan jaring/mosquito net untuk elak serangga masuk?","Adakah pencahayaan di kawasan pemprosesan mencukupi dan tidak menyebabkan risiko pencemaran makanan?","Adakah lampu yang berpenutup digunakan di kawasan pemprosesan?","Adakah sistem pengudaraan premis berfungsi baik dan aliran udara bergerak dari kawasan bersih ke kawasan kurang bersih (bukan sebaliknya)?","Adakah bilik air/tandas disediakan dalam jumlah mencukupi?","Adakah bilik air/tandas tidak terus bersambung dengan ruang pemprosesan makanan?","Adakah premis mempunyai stor yang berasingan untuk Bahan mentah?","Adakah premis mempunyai stor yang berasingan untuk Produk siap?","Adakah premis mempunyai stor yang berasingan untuk Bahan kimia/pembersihan?","Adakah premis menyediakan ruang solat kepada pekerja muslim?","Adakah premis menyediakan ruang persalinan kepada pekerja?","Adakah premis menyediakan ruang makan atau rehat kepada pekerja?","Adakah premis menyediakan kemudahan penyimpanan barang peribadi kepada pekerja?","Adakah premis memastikan alat dan unsur penyembahan tidak berada dalam kawasan pemprosesan?","Adakah premis memastikan tempat tinggal pekerja tidak berada dalam kawasan pemprosesan?","Adakah aliran proses pengeluaran makanan dalam premis satu arah (linear flow)?","Adakah terdapat pemisahan kawasan bersih dan kawasan kotor untuk mengelakkan pencemaran?"],
            bahan: ["Adakah semua bahan mentah (termasuk bahan tambahan & bahan pembungkusan primer) mempunyai sijil halal yang sah?","Jika bahan mentah diimport, adakah ia daripada badan pensijilan halal luar negara yang diiktiraf JAKIM?","Adakah rekod pembelian bahan mentah (invois, delivery order) disimpan dan boleh diaudit?","Adakah terdapat sebarang bahan mentah daripada sumber syubhah/diragui?","Adakah bahan mentah halal disimpan berasingan daripada bahan tidak halal/diragui?","Adakah stor bahan mentah dilabel dengan jelas?"],
            sanitasi: ["Adakah terdapat sinki untuk basuh tangan yang dilengkapi sabun, tisu/pengering automatik, dan air bersih?","Adakah terdapat jadual pembersihan dan sanitasi bertulis yang disediakan dan disemak?","Adakah tong sampah bertutup dan mudah dibersihkan digunakan dalam premis?","Adakah bilik air/tandas bersih, tidak berbau dan tidak terbuka secara langsung kepada kawasan pemprosesan?","Adakah terdapat sistem kawalan haiwan perosak (pest control)?"],
            pekerja: ["Adakah pekerja perniagaan telah menerima latihan kesedaran halal?","Adakah pekerja perniagaan telah menerima latihan halal?"],
            dokumentasi: ["Adakah dokumen dan rekod disimpan dengan baik, dikemaskini dan mudah untuk dirujuk?","Adakah perniagaan menyimpan rekod pembelian bahan mentah bersama sijil halal pembekal?"]
        };

        const questionPoints = {
            'syarat': [7, 7, 7, 7, 7], 
            'premis': [20, 7, 5, 3, 7, 7, 7, 7, 7, 7, 7, 7, 7, 5, 5, 7, 7, 5, 7, 7, 7, 7, 7, 7, 5, 3, 7, 5, 7, 7], 
            'bahan': [7, 7, 7, 7, 7, 5], 
            'sanitasi': [5, 5, 3, 5, 5], 
            'pekerja': [7, 5], 
            'dokumentasi': [5, 5] 
        };

        const getClientDocRef = (userId) => doc(window.db, `/artifacts/${appId}/users/${userId}/halal_readiness_assessment`, 'data');
        const getPublicSummaryDocRef = (userId) => doc(window.db, `/artifacts/${appId}/public/data/clients`, userId);
        
        const savePublicSummary = async (userId, dataToSave, score) => {
            try {
                const docRef = getPublicSummaryDocRef(userId);
                const summaryData = {
                    userId: userId,
                    clientName: dataToSave.answers['nama_perniagaan'] || 'Klien Baru',
                    currentStepTitle: flowSteps[dataToSave.currentStep].title,
                    currentStepIndex: dataToSave.currentStep,
                    totalSteps: flowSteps.length,
                    progressPercentage: ((dataToSave.currentStep / flowSteps.length) * 100).toFixed(0),
                    readinessScore: score.readinessScore.toFixed(2),
                    totalPointsScored: score.totalPointsScored,
                    lastUpdated: new Date().toISOString()
                };
                await setDoc(docRef, summaryData, { merge: true });
            } catch (error) {
                console.error("Error saving public summary for client", userId, ":", error); 
            }
        };
        
        const updateStateAndSave = async (newState) => {
             window.appState = { ...window.appState, ...newState };
            
            if (window.appState.authReady && window.appState.isAuthenticated && window.appState.userId) {
                try {
                    const privateDocRef = getClientDocRef(window.appState.userId);
                    const dataToSave = {
                        currentStep: window.appState.currentStep,
                        answers: window.appState.answers,
                        assessmentCompleted: window.appState.assessmentCompleted,
                        aiSummary: window.appState.aiSummary // Save AI summary
                    };
                    const score = window.calculateScore();
                    
                    await setDoc(privateDocRef, dataToSave, { merge: true });
                    await savePublicSummary(window.appState.userId, dataToSave, score);
                    
                } catch (error) {
                    console.error("Error saving data to Firestore:", error);
                }
            }
        };

        window.updateState = async (newState) => {
            window.appState = { ...window.appState, ...newState };
            window.renderApp(); // Full re-render
            await updateStateAndSave({}); // Save the latest state
        };

        window.manualSave = () => {
            updateStateAndSave({}); // Just save without re-rendering
            const statusMessage = document.getElementById('save-status-message');
            if (statusMessage) {
                const timestamp = new Date().toLocaleTimeString('ms-MY', { hour: '2-digit', minute: '2-digit' });
                statusMessage.textContent = `✅ Kemajuan Disimpan: ${timestamp}`;
                statusMessage.classList.remove('opacity-0', 'text-gray-500');
                statusMessage.classList.add('opacity-100', 'text-teal-600', 'font-medium');
                setTimeout(() => {
                    statusMessage.classList.remove('opacity-100', 'text-teal-600', 'font-medium');
                    statusMessage.classList.add('opacity-0', 'text-gray-500');
                }, 3000);
            }
        };
        
        window.logoutClient = async () => {
            if (window.auth) {
                try {
                    await signOut(window.auth);
                    window.location.href = 'index.html'; 
                } catch (error) {
                    console.error("Error signing out:", error);
                    alert("Gagal log keluar. Sila cuba lagi.");
                }
            }
        };

        window.handleAuth = async (isRegister) => {
            if (!window.auth) {
                 console.error("Authentication failed: Firebase Auth not initialized.");
                 document.getElementById('auth-error-message').textContent = "Ralat sistem: Gagal memulakan perkhidmatan log masuk.";
                 return;
            }
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const errorMessageElement = document.getElementById('auth-error-message');
            errorMessageElement.textContent = '';
            errorMessageElement.classList.remove('p-3', 'bg-red-100', 'border', 'border-red-400', 'rounded-lg');

            if (!email || !password) {
                errorMessageElement.textContent = "Sila masukkan emel dan kata laluan.";
                errorMessageElement.classList.add('p-3', 'bg-red-100', 'border', 'border-red-400', 'rounded-lg');
                return;
            }
            if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                errorMessageElement.textContent = "Sila masukkan format emel yang sah.";
                 errorMessageElement.classList.add('p-3', 'bg-red-100', 'border', 'border-red-400', 'rounded-lg');
                return;
            }

            try {
                if (isRegister) {
                    await createUserWithEmailAndPassword(window.auth, email, password);
                } else {
                    await signInWithEmailAndPassword(window.auth, email, password);
                }
            } catch (error) {
                console.error("Authentication failed:", error);
                let displayMessage = "Gagal log masuk. Sila cuba lagi.";
                if (error.code === 'auth/operation-not-allowed') {
                    displayMessage = "Ralat Konfigurasi: Log Masuk Emel/Kata Laluan belum diaktifkan.";
                } else if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                    displayMessage = "Emel atau kata laluan tidak sah. Sila semak semula.";
                } else if (error.code === 'auth/email-already-in-use') {
                    displayMessage = "Emel ini sudah berdaftar. Sila Log Masuk.";
                    window.updateState({ isRegisterMode: false });
                    return;
                } else if (error.code === 'auth/invalid-email') {
                    displayMessage = "Format emel tidak sah.";
                } else if (error.code === 'auth/weak-password') {
                    displayMessage = "Kata laluan terlalu lemah (minimum 6 aksara).";
                }
                errorMessageElement.textContent = displayMessage;
                errorMessageElement.classList.add('p-3', 'bg-red-100', 'border', 'border-red-400', 'rounded-lg');
            }
        };
        
        window.onload = async () => {
            try {
                app = initializeApp(firebaseConfig);
                window.db = getFirestore(app);
                window.auth = getAuth(app);

                onAuthStateChanged(window.auth, async (user) => {
                    if (user) {
                        const userId = user.uid;
                        window.appState = { ...window.appState, isAuthenticated: true, userId: userId, authReady: true };
                        
                        const publicSummaryRef = getPublicSummaryDocRef(userId);
                        const publicSummarySnap = await getDoc(publicSummaryRef);

                        if (!publicSummarySnap.exists()) {
                            const initialData = { answers: {}, currentStep: 0 };
                            const initialScore = { readinessScore: 0, totalPointsScored: 0 };
                            await savePublicSummary(userId, initialData, initialScore);
                        }

                        const privateDocRef = getClientDocRef(userId);
                        onSnapshot(privateDocRef, (docSnap) => {
                            if (docSnap.exists()) {
                                const data = docSnap.data();
                                // --- MODIFICATION START: Force to result tab if completed ---
                                let currentStep = data.currentStep || 0;
                                const assessmentCompleted = data.assessmentCompleted || false;
                                
                                if (assessmentCompleted) {
                                    currentStep = flowSteps.findIndex(step => step.id === 'result');
                                    if (currentStep === -1) currentStep = 0; // Fallback
                                }
                                // --- MODIFICATION END ---

                                window.appState = { 
                                    ...window.appState, 
                                    currentStep: currentStep, // Use modified step
                                    answers: data.answers || {}, 
                                    assessmentCompleted: assessmentCompleted, // Use saved value
                                    aiSummary: data.aiSummary || null
                                };
                            }
                            window.renderApp();
                        }, (error) => {
                            console.error("Error setting up onSnapshot:", error);
                            window.renderApp();
                        });

                    } else {
                        window.appState = { ...window.appState, isAuthenticated: false, authReady: true };
                        window.renderApp();
                    }
                });
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                window.appState = { ...window.appState, authReady: true };
                window.renderApp();
            }
        };

        window.calculateScore = () => {
            const MAX_TOTAL_POINTS = 321;
            let totalPointsScored = 0, totalScoredQuestions = 0, totalAnswered = 0, countYa = 0, countTidak = 0;
            const scoredSections = ['syarat', 'premis', 'bahan', 'sanitasi', 'pekerja', 'dokumentasi'];
            
            scoredSections.forEach(sectionId => {
                const questions = (sectionId === 'syarat') ? flowSteps.find(s => s.id === 'syarat').questions : qaQuestions[sectionId];
                const points = questionPoints[sectionId] || [];
                totalScoredQuestions += questions.length;

                questions.forEach((q, index) => {
                    const answer = window.appState.answers[`${sectionId}_${index}`];
                    if (answer) {
                        totalAnswered++;
                        let isReadyAnswer = (answer === 'YA');

                        if (sectionId === 'bahan' && index === 3) { 
                            isReadyAnswer = (answer === 'TIDAK'); 
                        }
                        
                        if ( (sectionId === 'syarat' && (index === 3 || index === 4)) || (sectionId === 'bahan' && index === 1) ) {
                            isReadyAnswer = (answer === 'YA' || answer === 'Tidak Berkenaan');
                        }

                        if (isReadyAnswer) { 
                            totalPointsScored += points[index] || 0; 
                        } 
                        
                        if (answer === 'YA' || answer === 'Tidak Berkenaan') {
                            countYa++; 
                        } else if (answer === 'TIDAK') { 
                            countTidak++; 
                        }
                    }
                });
            });

            const readinessScore = MAX_TOTAL_POINTS > 0 ? (totalPointsScored / MAX_TOTAL_POINTS) * 100 : 0;
            return { readinessScore: parseFloat(readinessScore.toFixed(2)), totalPointsScored, totalQuestions: MAX_TOTAL_POINTS, totalAnswered, totalScoredQuestions, answerBreakdown: { ya: countYa, tidak: countTidak, notAnswered: totalScoredQuestions - totalAnswered } };
        };
        
        window.saveAIAnalysis = () => {
            const summaryContent = document.getElementById('ai-summary-content').innerHTML;
            const saveBtn = document.getElementById('save-ai-summary-btn');
            if (summaryContent && saveBtn) {
                updateStateAndSave({ aiSummary: summaryContent });
                saveBtn.textContent = '✅ Disimpan';
                saveBtn.disabled = true;
            }
        };

        window.generateAIAnalysis = async () => {
            const summaryContainer = document.getElementById('ai-summary-container');
            const summaryContent = document.getElementById('ai-summary-content');
            const generateBtn = document.getElementById('generate-ai-btn');

            if (!summaryContainer || !summaryContent || !generateBtn) return;

            summaryContainer.style.display = 'block';
            summaryContent.innerHTML = '<div class="flex items-center justify-center p-4"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-500"></div><p class="ml-4 text-indigo-600">AI sedang menganalisis data anda...</p></div>';
            generateBtn.disabled = true;
            generateBtn.innerHTML = '<span class="animate-pulse">Menjana...</span>';

            try {
                const score = window.calculateScore();
                const answers = window.appState.answers;
                const scoredSections = ['syarat', 'premis', 'bahan', 'sanitasi', 'pekerja', 'dokumentasi'];
                
                let gapsText = "";
                const allGaps = [];
                const flowStepsMap = flowSteps.reduce((map, step) => {
                    if (step.type === 'qa' || step.type === 'checklist') map[step.id] = step;
                    return map;
                }, {});
                scoredSections.forEach(sectionId => {
                    const questions = (sectionId === 'syarat') ? flowSteps.find(s => s.id === 'syarat').questions : qaQuestions[sectionId];
                    const secTitle = flowStepsMap[sectionId]?.title.replace(/^\d+\.\s*/, '') || 'Unknown';
                    questions.forEach((q, index) => {
                        const answer = answers[`${sectionId}_${index}`];
                        let isGap = (sectionId === 'bahan' && index === 3) ? (answer === 'YA') : (answer === 'TIDAK');
                        if (isGap) { allGaps.push(`- Bahagian ${secTitle}: ${q.replace(/\*/g, '').trim()}`); }
                    });
                });
                gapsText = allGaps.length > 0 ? allGaps.join('\n') : "Tiada jurang kritikal dikesan.";

                // --- MODIFICATION START ---
                const today = new Date();
                const formattedDate = `${today.getDate().toString().padStart(2, '0')}/${(today.getMonth() + 1).toString().padStart(2, '0')}/${today.getFullYear()}`;
                const consultantName = "Unit Halal UniKL MICET";
                // --- MODIFICATION END ---

                const businessInfo = `
- Nama Perniagaan: ${answers.nama_perniagaan || 'Tidak dinyatakan'}
- Kategori Industri: ${answers.kategori_0 === 'YA' ? 'Mikro' : answers.kategori_1 === 'YA' ? 'Kecil' : 'Tidak dinyatakan'}
- Skim Pensijilan Dipilih: ${Object.keys(answers).filter(k => k.startsWith('skim_')).map((k, i) => answers[k] === 'YA' ? flowSteps.find(s => s.id === 'skim').options[i] : null).filter(Boolean).join(', ') || 'Tidak dinyatakan'}
- Ulasan Klien: ${answers.ulasan_cabaran_utama || 'Tiada ulasan.'}
                `.trim();
                
                // --- MODIFICATION: Added date and consultant to the prompt ---
                const userQuery = `
Anda adalah seorang perunding Halal profesional dari **${consultantName}**. Tugas anda adalah untuk menyediakan ringkasan analisis dan cadangan tindakan berdasarkan data semakan kendiri (self-assessment) yang diberikan.

Tarikh Analisis: ${formattedDate}
Disediakan Oleh: ${consultantName}

Berikut adalah data daripada klien:
**1. Maklumat Asas Perniagaan:**
${businessInfo}
**2. Ringkasan Skor Ketersediaan Halal:**
- Peratus Ketersediaan: ${score.readinessScore.toFixed(0)}%
- Mata Diperolehi: ${score.totalPointsScored} / ${score.totalQuestions}
- Analisis Jawapan: ${score.answerBreakdown.ya} YA, ${score.answerBreakdown.tidak} TIDAK, ${score.answerBreakdown.notAnswered} Belum Dijawab.
**3. Senarai Jurang (GAP) Kritikal yang Dikesan (berdasarkan jawapan "TIDAK"):**
${gapsText}

**Tugasan Anda:**
Berdasarkan semua data di atas, sila jana satu rumusan analisis dalam format Markdown. Rumusan ini mestilah:
a. **Profesional dan Membina:** Gunakan nada yang menyokong dan memberi galakan.
b. **Berstruktur:** Susun dalam tiga bahagian utama. Anda **MESTI** menggunakan tajuk (headings) \`###\` yang tepat seperti di bawah:
    ### 1. Analisis Keseluruhan
    ### 2. Fokus Utama Penambahbaikan
    ### 3. Langkah Seterusnya yang Dicadangkan
c. **Spesifik dan Boleh Diambil Tindakan:** Berikan cadangan yang jelas dan praktikal. Kaitkan cadangan terus kepada jurang yang disenaraikan.
d. **Bahasa Melayu:** Tulis keseluruhan rumusan dalam Bahasa Melayu.
Sila mulakan rumusan anda.
                `.trim();
                // --- MODIFICATION END ---

                const apiKey = "AIzaSyAIWAvEdk7BByB-9Y8zYLOD3LIbw1P9Erc"; 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
                const payload = { contents: [{ parts: [{ text: userQuery }] }] };
                
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`API request failed with status ${response.status}`);
                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    let generatedText = candidate.content.parts[0].text;
                    generatedText = generatedText
                        .replace(/### (.*)/g, '<h5 class="text-lg font-bold text-gray-800 mt-4 mb-2">$1</h5>')
                        .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
                        .replace(/\* (.*)/g, '<li class="ml-5 list-disc">$1</li>')
                        .replace(/(\d)\. (.*)/g, '<li class="ml-5" style="list-style-type: decimal;">$2</li>')
                        .replace(/\n/g, '<br>');
                    summaryContent.innerHTML = generatedText;
                    const buttonsContainer = summaryContent.nextElementSibling;
                    if(buttonsContainer) buttonsContainer.remove(); // Remove old buttons if they exist
                    
                    summaryContent.insertAdjacentHTML('afterend', `
                        <div class="mt-4 text-center space-x-2">
                           <button id="save-ai-summary-btn" onclick="window.saveAIAnalysis()" class="btn-secondary px-4 py-2 rounded-lg font-semibold">Simpan Rumusan Ini</button>
                           <!-- REMOVED: Muat Turun PDF Button -->
                        </div>
                    `);
                } else {
                    throw new Error("Invalid response structure from API.");
                }

            } catch (error) {
                console.error("Error generating AI Analysis:", error);
                summaryContent.innerHTML = '<p class="text-red-600 font-semibold">Maaf, berlaku ralat semasa menjana rumusan. Sila cuba sebentar lagi.</p>';
            } finally {
                generateBtn.disabled = false;
                generateBtn.innerHTML = '<svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg>Jana Semula Analisis AI';
            }
        };

        window.renderGapsTable = (answers, scoredSections) => {
            let allGaps = [];
            const flowStepsMap = flowSteps.reduce((map, step) => {
                if (step.type === 'qa' || step.type === 'checklist') map[step.id] = step;
                return map;
            }, {});
            scoredSections.forEach(sectionId => {
                const questions = (sectionId === 'syarat') ? flowSteps.find(s => s.id === 'syarat').questions : qaQuestions[sectionId];
                const points = questionPoints[sectionId] || [];
                const secTitle = flowStepsMap[sectionId]?.title.replace(/^\d+\.\s*/, '') || 'Unknown';
                questions.forEach((q, index) => {
                    const answer = answers[`${sectionId}_${index}`];
                    let isGap = (sectionId === 'bahan' && index === 3) ? (answer === 'YA') : (answer === 'TIDAK');
                    if (isGap) {
                        allGaps.push({ section: secTitle, question: q.replace(/\*/g, '').trim(), pointValue: points[index] || 0 });
                    }
                });
            });
            if (allGaps.length === 0) return '<p class="text-sm text-green-600 p-4 border rounded-lg bg-green-50">Tiada jurang kritikal dikesan.</p>';
            return `<div class="overflow-x-auto shadow-md rounded-lg"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Bahagian</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Soalan Jurang (GAP)</th><th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">Mata Hilang</th></tr></thead><tbody class="bg-white divide-y divide-gray-200">${allGaps.map(gap => `<tr class="hover:bg-red-50/50"><td class="px-6 py-4 text-sm font-medium text-red-700">${gap.section}</td><td class="px-6 py-4 text-sm">${gap.question}</td><td class="px-6 py-4 text-center text-sm font-bold text-red-600">${gap.pointValue}</td></tr>`).join('')}</tbody></table></div>`;
        };

        window.renderPieChart = (answerBreakdown, canvasTarget, onCompleteCallback = null) => {
            let canvasEl = typeof canvasTarget === 'string' ? document.getElementById(canvasTarget) : canvasTarget;
            if (!canvasEl) { if (onCompleteCallback) onCompleteCallback(); return null; }
            const existingChart = Chart.getChart(canvasEl);
            if (existingChart) { existingChart.destroy(); }
            
            return new Chart(canvasEl, {
                type: 'pie', data: { labels: ['YA (Halal Ready)', 'TIDAK (Perlu Tindakan)', 'Belum Dijawab'], datasets: [{ data: [answerBreakdown.ya, answerBreakdown.tidak, answerBreakdown.notAnswered], backgroundColor: ['#0d9488', '#dc2626', '#e5e7eb'], hoverOffset: 4 }] },
                options: { 
                    responsive: true, 
                    animation: { onComplete: () => { if (onCompleteCallback) onCompleteCallback(); } },
                    plugins: { 
                        legend: { position: 'bottom', labels: { font: { family: 'Inter', size: 14 } } }, 
                        title: { display: true, text: 'Analisis Jawapan Keseluruhan', font: { size: 18, family: 'Inter', weight: 'bold' } } 
                    } 
                }
            });
        };
        
        window.toggleModal = (show) => {
            const modal = document.getElementById('report-modal');
            if (modal) {
                modal.style.display = show ? 'flex' : 'none';
                if (show) {
                    const modalBody = document.getElementById('modal-report-body');
                    if (modalBody) {
                        modalBody.innerHTML = window.renderReportContent();
                        setTimeout(() => {
                            const score = window.calculateScore();
                            if (score.totalAnswered > 0) {
                                window.renderPieChart(score.answerBreakdown, 'modalReportPieChart');
                            }
                        }, 100);
                    }
                }
            }
        };

        window.renderReportCover = () => {
            const answers = window.appState.answers;
            const today = new Date();
            const formattedDate = `${today.getDate().toString().padStart(2, '0')}/${(today.getMonth() + 1).toString().padStart(2, '0')}/${today.getFullYear()}`;
            
            return `
            <div id="pdf-cover-page" class="bg-white p-8" style="width: 210mm; height: 297mm; display: flex; flex-direction: column; justify-content: space-between; border: 1px solid #eee;">
                <div><h1 class="text-5xl font-extrabold text-gray-800">eHalal<span class="text-teal-600">GAP</span></h1><p class="text-lg text-gray-500 mt-2">Platform Analisis Kendiri untuk Pensijilan Halal</p></div>
                <div class="text-center"><h2 class="text-4xl font-bold text-gray-700">Laporan Semakan Jurang Halal</h2><div class="mt-12 border-t-2 border-teal-500 w-24 mx-auto"></div><p class="mt-8 text-3xl font-semibold">${answers.nama_perniagaan || 'Nama Perniagaan'}</p>${answers.no_ssm_jika_ada_ ? `<p class="mt-2 text-lg text-gray-600">${answers.no_ssm_jika_ada_}</p>` : ''}</div>
                <div class="text-sm text-gray-600"><div class="grid grid-cols-2 gap-4"><div><p class="font-bold">Disediakan Untuk:</p><p>${answers.nama_pemilik || answers.nama_perniagaan}</p></div><div><p class="font-bold">Tarikh Laporan:</p><p>${formattedDate}</p></div><div><p class="font-bold">Disediakan Oleh:</p><p>Sistem Automasi eHalalGAP</p></div><div><p class="font-bold">ID Laporan:</p><p>EHG-${today.getTime()}</p></div></div><p class="mt-8 text-xs text-gray-500 italic">Dokumen ini adalah sulit dan mengandungi maklumat proprietari. Ia dihasilkan untuk kegunaan dalaman penerima sahaja dan tidak boleh disebarkan tanpa kebenaran bertulis.</p><p class="text-center mt-4 text-xs">&copy; Hak Cipta ACE UniKL MICET ${new Date().getFullYear()}.</p></div>
            </div>`;
        };

        window.downloadReportPDF = async () => {
            const downloadButton = document.querySelector('button[onclick="window.downloadReportPDF()"]');
            const originalButtonText = downloadButton.innerHTML;
            downloadButton.innerHTML = '<span class="animate-pulse">Menjana PDF...</span>';
            downloadButton.disabled = true;

            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = pdf.internal.pageSize.getHeight();
            
            // --- Helper: A4 Page Container (untuk menangkap imej) ---
            const tempCaptureContainer = document.createElement('div');
            tempCaptureContainer.style.position = 'absolute';
            tempCaptureContainer.style.left = '-9999px';
            // Styling Halaman A4
            const a4PageStyle = `width: 210mm; height: 297mm; padding: 20px; background-color: white; color: black; font-family: 'Inter', sans-serif; display: flex; flex-direction: column; justify-content: space-between;`;
            tempCaptureContainer.style.cssText += a4PageStyle;
            document.body.appendChild(tempCaptureContainer);

            // --- Helper: Fungsi untuk menangkap 'div' kontena semasa ---
            const capturePage = async () => {
                const canvas = await html2canvas(tempCaptureContainer, {
                    scale: 2,
                    useCORS: true,
                    width: tempCaptureContainer.scrollWidth,
                    height: tempCaptureContainer.scrollHeight,
                    windowWidth: tempCaptureContainer.scrollWidth,
                    windowHeight: tempCaptureContainer.scrollHeight
                });
                return canvas.toDataURL('image/jpeg', 0.98);
            };

            // --- Helper: Header & Footer Halaman ---
            const getPageHeader = () => `<div class="text-center pb-4 border-b"><h2 class="text-3xl font-extrabold text-gray-800">eHalal<span class="text-teal-600">GAP</span></h2><h1 class="text-xl font-bold text-gray-700 mt-1">Laporan Semakan Jurang Halal</h1></div>`;
            const getPageFooter = (pageNum) => `<div class="mt-auto text-xs text-gray-500 text-center pt-4 border-t"><p class="mb-1">&copy; Hak Cipta ACE UniKL MICET ${new Date().getFullYear()}.</p><p>Muka Surat ${pageNum}</p></div>`;

            // --- Dapatkan Data (disalin dari renderReportContent) ---
            const score = window.calculateScore();
            const progress = score.readinessScore;
            const answers = window.appState.answers;
            const scoredSections = ['syarat', 'premis', 'bahan', 'sanitasi', 'pekerja', 'dokumentasi'];
            let status = '', statusColor = '', recommendation = '';
            if (progress >= 80) { status = 'Bersedia'; statusColor = 'bg-green-100 text-green-700 border-green-500'; recommendation = 'Tahniah! Perniagaan anda menunjukkan ketersediaan tinggi.'; } 
            else if (progress >= 60) { status = 'Kurang Bersedia'; statusColor = 'bg-yellow-100 text-yellow-700 border-yellow-500'; recommendation = 'Perniagaan anda di tahap sederhana. Fokus pada jawapan "TIDAK".'; } 
            else { status = 'Tidak Bersedia'; statusColor = 'bg-red-100 text-red-700 border-red-500'; recommendation = 'Perniagaan anda memerlukan penambahbaikan signifikan.'; }
            const clientReview = answers['ulasan_cabaran_utama'];

            try {
                // --- 1. Tambah Muka Depan (Cover Page) ---
                const tempCoverContainer = document.createElement('div');
                tempCoverContainer.style.position = 'absolute';
                tempCoverContainer.style.left = '-9999px';
                tempCoverContainer.innerHTML = window.renderReportCover();
                document.body.appendChild(tempCoverContainer);
                const coverElement = document.getElementById('pdf-cover-page');
                
                const coverCanvas = await html2canvas(coverElement, { scale: 2 });
                const coverImgData = coverCanvas.toDataURL('image/jpeg', 0.98);
                pdf.addImage(coverImgData, 'JPEG', 0, 0, pdfWidth, pdfHeight);
                document.body.removeChild(tempCoverContainer);

                // --- 2. Tambah Muka Surat 1: Ringkasan + Maklumat ---
                pdf.addPage();
                const page1HTML = `
                    <div>${getPageHeader()}</div>
                    <div class="flex-grow"> <!-- flex-grow untuk mengisi ruang -->
                        <!-- Ringkasan Keputusan -->
                        <div class="mt-8 p-6 rounded-xl shadow-lg border"><h3 class="text-2xl font-bold mb-4 text-center">Ringkasan Keputusan</h3><div class="flex flex-col sm:flex-row items-center justify-around text-center"><div><p class="text-5xl font-extrabold text-teal-600">${progress.toFixed(0)}%</p><p class="text-xl mt-1">Ketersediaan</p></div><div><p class="text-5xl font-extrabold">${score.totalPointsScored}/${score.totalQuestions}</p><p class="text-xl mt-1">Mata Halal</p></div></div></div>
                        <div class="mt-8 text-center p-6 rounded-xl border-4 ${statusColor} shadow-md"><p class="text-2xl font-bold">Status: <span class="text-3xl">${status.toUpperCase()}</span></p><p class="mt-4">${recommendation}</p></div>
                        <!-- Maklumat Perniagaan -->
                        <div class="mt-8 p-6 bg-gray-50 rounded-xl shadow-sm border"><h4 class="text-xl font-semibold mb-4 border-b pb-2">Maklumat Perniagaan</h4><div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm font-bold">${['Nama Perniagaan','No SSM (jika ada)','Alamat','No Telefon','Nama Pemilik','Jualan tahunan perniagaan','Bilangan pekerja keseluruhan'].map(f => `<p><strong>${f}:</strong> ${answers[f.toLowerCase().replace(/[^a-z0-9]/g,'_').replace(/_+/g,'_')] || '- '}</p>`).join('')}</div></div>
                        ${clientReview ? `<div class="mt-8 p-6 bg-gray-50 rounded-xl shadow-sm border"><h4 class="text-xl font-semibold mb-4 border-b pb-2">Ulasan Klien</h4><p class="text-sm whitespace-pre-wrap">${clientReview}</p></div>` : ''}
                    </div>
                    ${getPageFooter(1)}
                `;
                tempCaptureContainer.innerHTML = page1HTML;
                let imgData = await capturePage();
                pdf.addImage(imgData, 'JPEG', 0, 0, pdfWidth, pdfHeight);

                // --- 3. Tambah Muka Surat 2: Carta Pai ---
                pdf.addPage();
                const page2HTML = `
                    <div>${getPageHeader()}</div>
                    <div class="flex-grow flex flex-col justify-center"> <!-- Letak di tengah -->
                        <div class="p-6 bg-white rounded-xl"><h4 class="text-xl font-semibold mb-6 border-b pb-2 text-center">Analisis Jawapan</h4><div class="flex justify-center w-full max-w-lg mx-auto"><canvas id="pdfReportPieChart" width="400" height="400"></canvas></div></div>
                    </div>
                    ${getPageFooter(2)}
                `;
                tempCaptureContainer.innerHTML = page2HTML;
                
                if (score.totalAnswered > 0) {
                    const originalAnimation = Chart.defaults.animation;
                    Chart.defaults.animation = false;
                    await new Promise(resolve => window.renderPieChart(score.answerBreakdown, tempCaptureContainer.querySelector('#pdfReportPieChart'), resolve));
                    Chart.defaults.animation = originalAnimation;
                }
                await new Promise(r => setTimeout(r, 500)); // Beri masa untuk carta render
                
                imgData = await capturePage();
                pdf.addImage(imgData, 'JPEG', 0, 0, pdfWidth, pdfHeight);
                
                // --- 4. Tambah Muka Surat 3: Jadual Jurang (Gaps) ---
                pdf.addPage();
                const page3HTML = `
                    <div>${getPageHeader()}</div>
                    <div class="flex-grow">
                        <div class="mt-8 p-6 bg-white rounded-xl shadow-lg border-t-4 border-red-500"><h4 class="text-xl font-bold text-red-700 mb-4 border-b pb-2">Jurang Pematuhan Kritikal</h4>${window.renderGapsTable(answers, scoredSections)}</div>
                    </div>
                    ${getPageFooter(3)}
                `;
                tempCaptureContainer.innerHTML = page3HTML;
                imgData = await capturePage();
                pdf.addImage(imgData, 'JPEG', 0, 0, pdfWidth, pdfHeight);

                // --- 5. Tambah Muka Surat 4: Analisis Bahagian ---
                pdf.addPage();
                const page4HTML = `
                    <div>${getPageHeader()}</div>
                    <div class="flex-grow">
                        <div class="mt-8 p-6 bg-white rounded-xl shadow-lg"><h4 class="text-xl font-semibold mb-6 border-b pb-2">Analisis Mengikut Bahagian</h4>${scoredSections.map(sId => { const qs = (sId === 'syarat') ? flowSteps.find(s=>s.id===sId).questions : qaQuestions[sId]; const pts = questionPoints[sId] || []; let secMax=0, secScore=0; pts.forEach(p=>{secMax+=p;}); qs.forEach((q,idx) => { const ans = answers[`${sId}_${idx}`]; let isReady= (ans==='YA'); if(sId==='bahan'&& idx===3) isReady=(ans==='TIDAK'); if(isReady) secScore+=pts[idx]; }); const secPerc = secMax > 0 ? (secScore / secMax) * 100 : 0; const secTitle = flowSteps.find(s=>s.id===sId)?.title.replace(/^\d+\.\s*/, '') || sId; const barColor = secPerc >= 80 ? 'bg-green-500' : secPerc >= 60 ? 'bg-yellow-500' : 'bg-red-500'; return `<div class="mb-6 border-b pb-4"><h5 class="text-lg font-bold">${secTitle}</h5><div class="flex justify-between items-center mb-1"><span class="text-sm">Skor: ${secScore}/${secMax}</span><span class="text-lg font-bold">${secPerc.toFixed(0)}%</span></div><div class="w-full bg-gray-200 rounded-full h-3"><div class="${barColor} h-3 rounded-full" style="width: ${secPerc.toFixed(0)}%"></div></div></div>`; }).join('')}</div>
                    </div>
                    ${getPageFooter(4)}
                `;
                tempCaptureContainer.innerHTML = page4HTML;
                imgData = await capturePage();
                pdf.addImage(imgData, 'JPEG', 0, 0, pdfWidth, pdfHeight);

            } catch (error) {
                console.error("Error generating PDF:", error);
                alert("Gagal menjana PDF. Sila cuba lagi.");
            } finally {
                // --- 6. Bersihkan (Cleanup) dan Simpan ---
                document.body.removeChild(tempCaptureContainer);
                const clientName = window.appState.answers['nama_perniagaan'] || 'laporan-ehalalgap';
                pdf.save(`${clientName.replace(/\s+/g, '_').toLowerCase()}_${new Date().toISOString().slice(0,10)}.pdf`);
                downloadButton.innerHTML = originalButtonText;
                downloadButton.disabled = false;
            }
        };
        
        // --- MODIFICATION START: Replaced entire downloadAISummaryPDF function ---
        window.downloadAISummaryPDF = async (event) => {
            const downloadButton = event.target;
            const originalButtonText = downloadButton.innerHTML;
            downloadButton.innerHTML = '<span class="animate-pulse">Menjana...</span>';
            downloadButton.disabled = true;

            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = pdf.internal.pageSize.getHeight();
            
            // Define margins and content area
            const topMargin = 30; // Ruang untuk header
            const bottomMargin = 25; // Ruang untuk footer
            const leftMargin = 15;
            const rightMargin = 15;
            const contentWidth = pdfWidth - leftMargin - rightMargin;
            const pageContentHeight = pdfHeight - topMargin - bottomMargin; // Ketinggian untuk imej pada setiap halaman
            
            const clientName = window.appState.answers['nama_perniagaan'] || 'Klien eHalalGAP';
            const allContentHTML = document.getElementById('ai-summary-content').innerHTML;

            // --- Helper function to add Header/Footer to *every* page ---
            const addHeaderFooter = (pageNum) => {
                pdf.setFont('helvetica', 'bold');
                pdf.setFontSize(18);
                pdf.setTextColor('#1a4f78'); // Deep blue
                pdf.text('Rumusan Analisis AI', pdfWidth / 2, 17, { align: 'center' });
                
                pdf.setFont('helvetica', 'normal');
                pdf.setFontSize(12);
                pdf.setTextColor('#555555');
                pdf.text(clientName, pdfWidth / 2, 23, { align: 'center' });

                // Footer
                pdf.setFont('helvetica', 'normal');
                pdf.setFontSize(9);
                pdf.setTextColor('#888888');
                const footerText = `© Hak Cipta ACE UniKL MICET ${new Date().getFullYear()}. Laporan dijana oleh eHalalGAP.`;
                const pageNumText = `Muka Surat ${pageNum}`;
                
                pdf.text(footerText, leftMargin, pdfHeight - 15);
                pdf.text(pageNumText, pdfWidth - rightMargin, pdfHeight - 15, { align: 'right' });
            };

            // --- MODIFICATION START: Manually create "Butiran Data" ---
            const score = window.calculateScore();
            const answers = window.appState.answers;

            const businessInfo = `
- Nama Perniagaan: ${answers.nama_perniagaan || 'Tidak dinyatakan'}
- Kategori Industri: ${answers.kategori_0 === 'YA' ? 'Mikro' : answers.kategori_1 === 'YA' ? 'Kecil' : 'Tidak dinyatakan'}
- Skim Pensijilan Dipilih: ${Object.keys(answers).filter(k => k.startsWith('skim_')).map((k, i) => answers[k] === 'YA' ? flowSteps.find(s => s.id === 'skim').options[i] : null).filter(Boolean).join(', ') || 'Tidak dinyatakan'}
- Ulasan Klien: ${answers.ulasan_cabaran_utama || 'Tiada ulasan.'}
            `.trim().replace(/\n/g, '<br>');

            const scoreInfo = `
- Peratus Ketersediaan: ${score.readinessScore.toFixed(0)}%
- Mata Diperolehi: ${score.totalPointsScored} / ${score.totalQuestions}
- Analisis Jawapan: ${score.answerBreakdown.ya} YA, ${score.answerBreakdown.tidak} TIDAK, ${score.answerBreakdown.notAnswered} Belum Dijawab.
            `.trim().replace(/\n/g, '<br>');

            // Re-create gaps list
            const scoredSections = ['syarat', 'premis', 'bahan', 'sanitasi', 'pekerja', 'dokumentasi'];
            let gapsText = "";
            const allGaps = [];
            const flowStepsMap = flowSteps.reduce((map, step) => {
                if (step.type === 'qa' || step.type === 'checklist') map[step.id] = step;
                return map;
            }, {});
            scoredSections.forEach(sectionId => {
                const questions = (sectionId === 'syarat') ? flowSteps.find(s => s.id === 'syarat').questions : qaQuestions[sectionId];
                const secTitle = flowStepsMap[sectionId]?.title.replace(/^\d+\.\s*/, '') || 'Unknown';
                questions.forEach((q, index) => {
                    const answer = answers[`${sectionId}_${index}`];
                    let isGap = (sectionId === 'bahan' && index === 3) ? (answer === 'YA') : (answer === 'TIDAK');
                    if (isGap) { allGaps.push(`- Bahagian ${secTitle}: ${q.replace(/\*/g, '').trim()}`); }
                });
            });
            gapsText = (allGaps.length > 0 ? allGaps.join('<br>') : "Tiada jurang kritikal dikesan.").trim();

            const butiranDataHTML = `
                <h5 style="font-size: 1.1rem; font-weight: bold; color: #333; margin-top: 10px; margin-bottom: 8px; border-bottom: 1px solid #eee; padding-bottom: 4px;">Butiran Data Asas</h5>
                
                <h6 style="font-weight: bold; margin-top: 12px; margin-bottom: 4px;">1. Maklumat Asas Perniagaan:</h6>
                <div style="padding-left: 15px; font-size: 0.95rem;">${businessInfo}</div>
                
                <h6 style="font-weight: bold; margin-top: 12px; margin-bottom: 4px;">2. Ringkasan Skor Ketersediaan Halal:</h6>
                <div style="padding-left: 15px; font-size: 0.95rem;">${scoreInfo}</div>
                
                <h6 style="font-weight: bold; margin-top: 12px; margin-bottom: 4px;">3. Senarai Jurang (GAP) Kritikal Dikesan:</h6>
                <div style="padding-left: 15px; font-size: 0.95rem;">${gapsText}</div>
                
                <hr style="margin-top: 20px; margin-bottom: 20px; border-top: 1px dashed #ccc;">
            `;
            // --- MODIFICATION END ---


            // --- Capture container *only* holds content ---
            const tempContainer = document.createElement('div');
            tempContainer.style.position = 'absolute';
            tempContainer.style.left = '-9999px';
            // --- MODIFICATION: Use fixed pixel width for html2canvas stability ---
            tempContainer.style.width = '800px'; 
            tempContainer.style.padding = '0';
            tempContainer.style.margin = '0';
            tempContainer.style.backgroundColor = 'white';
            tempContainer.style.color = 'black';
            document.body.appendChild(tempContainer);
            
            // --- Helper function to add a (potentially long) content block to the PDF ---
            // This function handles its own pagination.
            const addContentToPDF = async (contentHTML, startPageNum) => {
                let currentPage = startPageNum;
                
                // Set content in temp container
                tempContainer.innerHTML = `<div style="font-family: 'Inter', sans-serif; font-size: 14px; color: black; background-color: white; width: 100%;">${contentHTML || ''}</div>`; // Slightly larger font for readability

                const canvas = await html2canvas(tempContainer, {
                    scale: 2, 
                    useCORS: true,
                    width: tempContainer.scrollWidth, 
                    height: tempContainer.scrollHeight,
                    windowWidth: tempContainer.scrollWidth,
                    windowHeight: tempContainer.scrollHeight
                });

                const imgWidth = contentWidth;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                let heightLeft = imgHeight;
                let position = 0; // Y-position of the image slice

                // Add first page for this section
                addHeaderFooter(currentPage);
                pdf.addImage(canvas, 'JPEG', leftMargin, topMargin, imgWidth, imgHeight);
                heightLeft -= pageContentHeight;

                // Add more pages if content is too tall
                while (heightLeft > 0) {
                    position -= pageContentHeight; // Move the image "up"
                    currentPage++;
                    pdf.addPage();
                    addHeaderFooter(currentPage); // Add header/footer to new page
                    pdf.addImage(canvas, 'JPEG', leftMargin, position + topMargin, imgWidth, imgHeight);
                    heightLeft -= pageContentHeight;
                }
                return currentPage; // Return the last page number used
            };

            try {
                // --- 1. Split content into 3 parts based on H5 headings ---
                // --- MODIFICATION: Made regex more robust to handle formatting (e.g., <strong>) inside <h5> tags ---
                const parts = allContentHTML.split(/(?=<h5[^>]*>.*?2\.\s*Fokus Utama Penambahbaikan.*?<\/h5>)/i);
                // --- MODIFICATION END ---
                
                // --- MODIFICATION: Prepend butiranDataHTML to Page 1 --- (This was correct from last time)
                const htmlPage1 = butiranDataHTML + (parts[0] || ''); // Page 1: Details + Overall Analysis
                let htmlPage2 = '';
                let htmlPage3 = '';

                if (parts[1]) {
                    const rest = parts[1];
                    // --- MODIFICATION: Made regex more robust to handle formatting (e.g., <strong>) inside <h5> tags ---
                    const parts2 = rest.split(/(?=<h5[^>]*>.*?3\.\s*Langkah Seterusnya yang Dicadangkan.*?<\/h5>)/i);
                    // --- MODIFICATION END ---
                    htmlPage2 = parts2[0] || ''; // Page 2: Focus
                    htmlPage3 = parts2[1] || ''; // Page 3: Next Steps
                }
                
                let currentPage = 1;
                
                // --- 2. Add Page 1 Content (Details + Analysis) ---
                currentPage = await addContentToPDF(htmlPage1, currentPage);

                // --- 3. Add Page 2 Content (Focus) ---
                if (htmlPage2) {
                    pdf.addPage();
                    currentPage++;
                    currentPage = await addContentToPDF(htmlPage2, currentPage);
                }

                // --- 4. Add Page 3 Content (Next Steps) ---
                if (htmlPage3) {
                    pdf.addPage();
                    currentPage++;
                    currentPage = await addContentToPDF(htmlPage3, currentPage);
                }

                const filename = `Rumusan_AI_${clientName.replace(/\s+/g, '_').toLowerCase()}.pdf`;
                pdf.save(filename);

            } catch (error) {
                console.error("Error generating AI Summary PDF:", error);
                alert("Gagal menjana PDF rumusan AI. Sila cuba lagi.");
            } finally {
                document.body.removeChild(tempContainer); // Cleanup
                downloadButton.innerHTML = "Muat Turun PDF";
                downloadButton.disabled = false;
            }
        };
        // --- MODIFICATION END ---

        window.renderLogin = () => {
            const isRegister = window.appState.isRegisterMode;
            return `<div class="h-screen flex items-center justify-center p-4"><div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-md"><h1 class="text-3xl font-bold mb-6 text-center text-gray-800">${isRegister ? 'Daftar Akaun Baharu' : 'Log Masuk Klien'}</h1><div class="space-y-4"><input type="email" id="email" placeholder="Alamat Emel" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500" /><input type="password" id="password" placeholder="Kata Laluan (Min 6 Aksara)" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500" /><p id="auth-error-message" class="text-sm text-red-500 text-center"></p><button onclick="window.handleAuth(${isRegister})" class="w-full btn-primary py-3 rounded-xl text-white font-semibold shadow-md hover:shadow-lg">${isRegister ? 'Daftar Sekarang' : 'Log Masuk'}</button><p class="text-center text-sm mt-4">${isRegister ? `Sudah ada akaun? <a href="#" onclick="window.updateState({ isRegisterMode: false })" class="text-teal-600 hover:text-teal-800 font-semibold">Log Masuk di sini</a>` : `Belum mendaftar? <a href="#" onclick="window.updateState({ isRegisterMode: true })" class="text-teal-600 hover:text-teal-800 font-semibold">Daftar Akaun Baharu</a>`}</p></div><p class="mt-6 text-xs text-center"><a href="index.html" class="text-teal-600 hover:text-teal-800 font-medium">&larr; Kembali ke Halaman Utama</a></p></div></div>`;
        };

        window.renderProgress = (score) => {
            const progressAnswered = (score.totalScoredQuestions > 0 ? (score.totalAnswered / score.totalScoredQuestions) * 100 : 0).toFixed(0);
            return `<div class="mb-8 p-6 bg-white rounded-xl shadow-lg border-l-4 border-teal-500"><h3 class="text-xl font-semibold mb-4 text-gray-800">Kemajuan Penilaian</h3><div class="bg-blue-50 border-l-4 border-blue-400 text-blue-700 p-4 mb-6 rounded-lg" role="alert"><p class="font-bold">Nota Penting:</p><p class="text-sm">Sila jawab semua soalan dengan jujur. Penilaian ini bertujuan untuk mengenal pasti jurang (GAP) sebenar perniagaan anda.</p></div><div class="flex flex-col items-center justify-center"><div class="flex flex-col items-center"><div class="progress-ring" style="--progress: ${progressAnswered}%;"><div class="progress-ring-inner">${progressAnswered}%</div></div><p class="mt-4 text-lg font-medium">Soalan Dijawab</p><p class="mt-1 text-sm text-gray-500">(${score.totalAnswered} dari ${score.totalScoredQuestions} soalan)</p></div></div></div>`;
        };
        
        window.renderTabContent = () => {
            const step = flowSteps[window.appState.currentStep];
            const currentAnswers = window.appState.answers;
            let html = `<h2 class="text-2xl font-bold mb-2">${step.title}</h2><p class="text-md text-gray-600 mb-6">${step.description}</p>`;
            
            if (step.id === 'syarat' || step.type === 'checklist' || step.type === 'qa') {
                const questions = step.id === 'syarat' ? step.questions : qaQuestions[step.id];
                html += '<div class="space-y-6">';
                questions.forEach((question, index) => {
                    const id = `${step.id}_${index}`;
                    const answer = currentAnswers[id] || '';
                    let options = ['YA', 'TIDAK'];
                    if ((step.id === 'syarat' && (index === 3 || index === 4)) || (step.id === 'bahan' && index === 1)) {
                        options.push('Tidak Berkenaan');
                    }
                    html += `<div class="bg-white p-5 rounded-xl shadow-lg border-t-4 border-teal-500/50"><p class="font-medium mb-3">${index + 1}. ${question}</p><div class="flex flex-wrap gap-3">${options.map(option => `<button onclick="window.handleAnswer('${id}', '${option}', true)" class="px-5 py-2 rounded-full text-sm font-semibold transition ${answer === option ? 'bg-teal-600 text-white shadow-md' : 'bg-gray-100 hover:bg-teal-100'}">${option}</button>`).join('')}</div></div>`;
                });
                html += '</div>';
                if (step.id === 'syarat') {
                    html += `<div class="mt-8 pt-4 border-t border-gray-200 text-sm text-gray-600 space-y-2"><p><strong>* FoSIM:</strong> (Food Safety Information System of Malaysia) - Sistem pendaftaran premis makanan online di bawah KKM.</p><p><strong>* NPRA:</strong> (National Pharmaceutical Regulatory Agency) - Agensi Regulatori Farmasi Negara, untuk pendaftaran produk kosmetik/farmaseutikal.</p></div>`;
                }
            } else if (step.type === 'selection') {
                 html += '<div class="space-y-4">';
                step.options.forEach((question, index) => {
                    const id = `${step.id}_${index}`;
                    let isDisabled = (step.id === 'kategori' && (index === 2 || index === 3)) || (step.id === 'skim' && ![0, 1, 3, 4].includes(index));
                    const labelClasses = `flex items-start p-4 rounded-xl shadow-sm transition duration-150 w-full ${isDisabled ? 'bg-gray-100 cursor-not-allowed opacity-60' : 'bg-white hover:shadow-md cursor-pointer'}`;
                    const inputAttributes = `type="radio" name="${step.id}" id="${id}" value="YA" ${currentAnswers[id] === 'YA' ? 'checked' : ''} onchange="window.handleAnswer('${id}', 'YA', true)" class="mt-1 h-5 w-5 ${isDisabled ? 'text-gray-400' : 'text-teal-600'} border-gray-300 rounded focus:ring-2 focus:ring-teal-500 flex-shrink-0" ${isDisabled ? 'disabled' : ''}`;
                    const spanClasses = `ml-3 ${isDisabled ? 'text-gray-500' : 'text-gray-700'}`;
                    const disabledText = isDisabled ? `<span class="ml-2 text-xs font-semibold text-gray-500">${step.id === 'kategori' ? '(Tidak Aktif)' : '(Akan Datang)'}</span>` : '';
                    html += `<label for="${id}" class="${labelClasses}"><input ${inputAttributes}><span class="${spanClasses}">${question}${disabledText}</span></label>`;
                });
                html += '</div>';
            } else if (step.type === 'form') {
                const fields = ['Nama Perniagaan', 'No SSM (jika ada)', 'Alamat', 'No Telefon', 'Nama Pemilik', 'Jualan tahunan perniagaan', 'Bilangan pekerja keseluruhan'];
                html += '<div class="space-y-6 bg-white p-6 rounded-xl shadow-lg">';
                fields.forEach(field => {
                    const id = field.toLowerCase().replace(/[^a-z0-9]/g, '_').replace(/_+/g, '_');
                    html += `<div><label for="${id}" class="block text-sm font-medium mb-1">${field} ${['Nama Perniagaan', 'No SSM (jika ada)', 'Alamat', 'No Telefon'].includes(field) ? '<span class="text-red-500">*</span>' : ''}</label><input type="${field.includes('Jualan') || field.includes('Bilangan') ? 'number' : 'text'}" id="${id}" value="${currentAnswers[id] || ''}" onchange="window.handleAnswer('${id}', this.value, false)" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-teal-500" placeholder="${field}"></div>`;
                });
                html += '</div>';
            } else if (step.type === 'textarea') {
                html += `<div class="bg-white p-6 rounded-xl shadow-lg"><div><label for="ulasan_cabaran_utama" class="block text-base font-medium mb-3">Apakah cabaran utama yang tuan/puan hadapi?</label><textarea id="ulasan_cabaran_utama" onchange="window.handleAnswer('ulasan_cabaran_utama', this.value, false)" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-teal-500" rows="10" placeholder="Sila nyatakan cabaran anda...">${currentAnswers['ulasan_cabaran_utama'] || ''}</textarea></div></div>`;
                // Notis amaran dipindahkan ke renderApp()
            } else if (step.type === 'result') {
                const score = window.calculateScore();
                const savedAISummary = window.appState.aiSummary;
                const aiButtonText = savedAISummary ? 'Jana Semula Analisis AI' : 'Jana Rumusan Analisis AI';
                const aiContainerDisplay = savedAISummary ? 'block' : 'none';

                html += window.renderReportSummary(score);
                html += `<div class="mt-8 flex flex-col sm:flex-row justify-center items-center space-y-4 sm:space-y-0 sm:space-x-4"><button onclick="window.toggleModal(true)" class="btn-primary text-white px-8 py-4 rounded-xl font-semibold shadow-lg hover:shadow-xl inline-flex items-center justify-center w-full sm:w-auto"><svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>Preview Laporan Penuh</button><button id="generate-ai-btn" onclick="window.generateAIAnalysis()" class="bg-indigo-600 text-white px-8 py-4 rounded-xl font-semibold shadow-lg hover:bg-indigo-700 transition inline-flex items-center justify-center w-full sm:w-auto"><svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg>${aiButtonText}</button></div>`;
                html += `<div id="ai-summary-container" class="mt-10 p-6 bg-gray-50 rounded-xl shadow-inner border border-gray-200" style="display: ${aiContainerDisplay};"><h4 class="text-xl font-bold text-indigo-800 mb-4 border-b pb-2 flex items-center"><svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg>Rumusan Analisis AI</h4><div id="ai-summary-content" class="text-gray-700 space-y-3 leading-relaxed">${savedAISummary || ''}</div>${savedAISummary ? `<div class="mt-4 text-center space-x-2"><button id="save-ai-summary-btn" class="btn-secondary px-4 py-2 rounded-lg font-semibold" disabled>✅ Disimpan</button><!-- REMOVED: Muat Turun PDF Button --></div>` : ''}</div>`;
                html += `<div class="mt-8 pt-4 border-t"><p class="text-xs text-gray-500 italic font-semibold">Notis Penafian:</p><p class="text-xs mt-1">Laporan ini disediakan berdasarkan penilaian kendiri. Ia hanyalah untuk rujukan dan tidak boleh dianggap sebagai bukti rasmi. Rumusan AI adalah cadangan am dan mungkin tidak merangkumi semua aspek.</p></div>`;
                setTimeout(() => { if (score.totalAnswered > 0) window.renderPieChart(score.answerBreakdown, 'reportPieChart'); }, 100);
            }
            return html;
        };

        window.renderReportSummary = (score) => {
            const progress = score.readinessScore;
            let status = '', statusColor = '', recommendation = '';
            if (progress >= 80) { status = 'Bersedia'; statusColor = 'bg-green-100 text-green-700 border-green-500'; recommendation = 'Tahniah! Perniagaan anda menunjukkan ketersediaan tinggi.'; }
            else if (progress >= 60) { status = 'Kurang Bersedia'; statusColor = 'bg-yellow-100 text-yellow-700 border-yellow-500'; recommendation = 'Perniagaan anda di tahap sederhana. Fokus pada jawapan "TIDAK".'; }
            else { status = 'Tidak Bersedia'; statusColor = 'bg-red-100 text-red-700 border-red-500'; recommendation = 'Perniagaan anda memerlukan penambahbaikan signifikan.'; }
            
            return `<div class="space-y-8"><div class="p-6 rounded-xl shadow-lg border"><h3 class="text-2xl font-bold mb-4 text-center">Ringkasan Keputusan</h3><div class="flex flex-col sm:flex-row items-center justify-around text-center space-y-4 sm:space-y-0"><div><p class="text-5xl font-extrabold text-teal-600">${progress.toFixed(0)}%</p><p class="text-xl mt-1">Peratus Ketersediaan</p></div><div><p class="text-5xl font-extrabold">${score.totalPointsScored}/${score.totalQuestions}</p><p class="text-xl mt-1">Mata Halal Diperolehi</p></div></div></div><div class="text-center p-6 rounded-xl border-4 ${statusColor} shadow-md"><p class="text-2xl font-bold">Status: <span class="text-3xl">${status.toUpperCase()}</span></p><p class="mt-4">${recommendation}</p></div><div class="p-6 bg-white rounded-xl shadow-lg"><h4 class="text-xl font-semibold mb-6 border-b pb-2">Analisis Jawapan</h4><div class="flex justify-center w-full max-w-lg mx-auto"><canvas id="reportPieChart" width="400" height="400"></canvas></div></div></div>`;
        };

        window.renderReportContent = () => {
            const score = window.calculateScore();
            const progress = score.readinessScore;
            const answers = window.appState.answers;
            // --- MODIFICATION: This variable is no longer used in the header ---
            // const clientIdentifier = answers.nama_perniagaan || (window.auth.currentUser ? window.auth.currentUser.email : window.appState.userId);
            const scoredSections = ['syarat', 'premis', 'bahan', 'sanitasi', 'pekerja', 'dokumentasi'];
            let status = '', statusColor = '', recommendation = '';
            if (progress >= 80) { status = 'Bersedia'; statusColor = 'bg-green-100 text-green-700 border-green-500'; recommendation = 'Tahniah! Perniagaan anda menunjukkan ketersediaan tinggi.'; } 
            else if (progress >= 60) { status = 'Kurang Bersedia'; statusColor = 'bg-yellow-100 text-yellow-700 border-yellow-500'; recommendation = 'Perniagaan anda di tahap sederhana. Fokus pada jawapan "TIDAK".'; } 
            else { status = 'Tidak Bersedia'; statusColor = 'bg-red-100 text-red-700 border-red-500'; recommendation = 'Perniagaan anda memerlukan penambahbaikan signifikan.'; }
            const clientReview = answers['ulasan_cabaran_utama'];
            
            // --- MODIFICATION START: Removed clientIdentifier <p> tag ---
            let reportHTML = `<div id="pdf-content-container" class="bg-white p-8">
                        <!-- Section 1: Header & Summary -->
                        <div class="text-center pb-4 border-b"><h2 class="text-3xl font-extrabold text-gray-800">eHalal<span class="text-teal-600">GAP</span></h2><h1 class="text-2xl font-bold text-gray-700 mt-2">Laporan Semakan Jurang Halal</h1></div>
                        <div class="mt-8 p-6 rounded-xl shadow-lg border"><h3 class="text-2xl font-bold mb-4 text-center">Ringkasan Keputusan</h3><div class="flex flex-col sm:flex-row items-center justify-around text-center"><div><p class="text-5xl font-extrabold text-teal-600">${progress.toFixed(0)}%</p><p class="text-xl mt-1">Ketersediaan</p></div><div><p class="text-5xl font-extrabold">${score.totalPointsScored}/${score.totalQuestions}</p><p class="text-xl mt-1">Mata Halal</p></div></div></div>
                        <!-- --- MODIFICATION END --- -->
                        <div class="mt-8 text-center p-6 rounded-xl border-4 ${statusColor} shadow-md"><p class="text-2xl font-bold">Status: <span class="text-3xl">${status.toUpperCase()}</span></p><p class="mt-4">${recommendation}</p></div>
                        <!-- Section 2: Business Info -->
                        <div class="mt-8 p-6 bg-gray-50 rounded-xl shadow-sm border"><h4 class="text-xl font-semibold mb-4 border-b pb-2">Maklumat Perniagaan</h4><div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm font-bold">${['Nama Perniagaan','No SSM (jika ada)','Alamat','No Telefon','Nama Pemilik','Jualan tahunan perniagaan','Bilangan pekerja keseluruhan'].map(f => `<p><strong>${f}:</strong> ${answers[f.toLowerCase().replace(/[^a-z0-9]/g,'_').replace(/_+/g,'_')] || '- '}</p>`).join('')}</div></div>
                        ${clientReview ? `<div class="mt-8 p-6 bg-gray-50 rounded-xl shadow-sm border"><h4 class="text-xl font-semibold mb-4 border-b pb-2">Ulasan Klien</h4><p class="text-sm whitespace-pre-wrap">${clientReview}</p></div>` : ''}
                        <!-- Section 3: Pie Chart -->
                        <div class="mt-8 p-6 bg-white rounded-xl shadow-lg"><h4 class="text-xl font-semibold mb-6 border-b pb-2">Analisis Jawapan</h4><div class="flex justify-center w-full max-w-lg mx-auto"><canvas id="modalReportPieChart" width="400" height="400"></canvas></div></div>
                        <!-- Section 4: Gaps Table -->
                        <div class="mt-8 p-6 bg-white rounded-xl shadow-lg border-t-4 border-red-500"><h4 class="text-xl font-bold text-red-700 mb-4 border-b pb-2">Jurang Pematuhan Kritikal</h4>${window.renderGapsTable(answers, scoredSections)}</div>
                        <!-- Section 5: Section Analysis -->
                        <div class="mt-8 p-6 bg-white rounded-xl shadow-lg"><h4 class="text-xl font-semibold mb-6 border-b pb-2">Analisis Mengikut Bahagian</h4>${scoredSections.map(sId => { const qs = (sId === 'syarat') ? flowSteps.find(s=>s.id===sId).questions : qaQuestions[sId]; const pts = questionPoints[sId] || []; let secMax=0, secScore=0; pts.forEach(p=>{secMax+=p;}); qs.forEach((q,idx) => { const ans = answers[`${sId}_${idx}`]; let isReady= (ans==='YA'); if(sId==='bahan'&& idx===3) isReady=(ans==='TIDAK'); if(isReady) secScore+=pts[idx]; }); const secPerc = secMax > 0 ? (secScore / secMax) * 100 : 0; const secTitle = flowSteps.find(s=>s.id===sId)?.title.replace(/^\d+\.\s*/, '') || sId; const barColor = secPerc >= 80 ? 'bg-green-500' : secPerc >= 60 ? 'bg-yellow-500' : 'bg-red-500'; return `<div class="mb-6 border-b pb-4"><h5 class="text-lg font-bold">${secTitle}</h5><div class="flex justify-between items-center mb-1"><span class="text-sm">Skor: ${secScore}/${secMax}</span><span class="text-lg font-bold">${secPerc.toFixed(0)}%</span></div><div class="w-full bg-gray-200 rounded-full h-3"><div class="${barColor} h-3 rounded-full" style="width: ${secPerc.toFixed(0)}%"></div></div></div>`; }).join('')}</div>
            `;

            reportHTML += `
                        <!-- Footer -->
                        <div class="mt-8 text-xs text-gray-500 text-center pt-4 border-t">&copy; Hak Cipta ACE UniKL MICET ${new Date().getFullYear()}.</div>
                    </div>`;
            return reportHTML;
        };

        window.handleAnswer = (key, value, shouldRender) => {
            let sanitizedValue = (typeof value === 'string') ? value.trim() : value;
            let newAnswers = { ...window.appState.answers, [key]: sanitizedValue };
            const currentStep = flowSteps[window.appState.currentStep];
            if (currentStep.type === 'selection' && value === 'YA') {
                currentStep.options.forEach((_, index) => {
                    const id = `${currentStep.id}_${index}`;
                    if (id !== key && newAnswers[id] === 'YA') delete newAnswers[id];
                });
            }
            if (shouldRender) window.updateState({ answers: newAnswers });
            else updateStateAndSave({ answers: newAnswers });
        };

        // --- MODIFICATION START: Add logic for completed assessment ---
        window.goToStep = (index) => {
            const resultStepIndex = flowSteps.findIndex(step => step.id === 'result');
            
            // If assessment is done, only allow clicking the result tab
            if (window.appState.assessmentCompleted && index !== resultStepIndex) {
                return; // Do nothing
            }
            
            // If assessment is not done, block clicking the result tab
            if (index === resultStepIndex && !window.appState.assessmentCompleted) {
                return; // Do nothing
            }
            
            if (index >= 0 && index < flowSteps.length) {
                window.updateState({ currentStep: index });
            }
        };
        // --- MODIFICATION END ---

        window.changeStep = async (direction) => {
            const newStepIndex = window.appState.currentStep + direction;
            if (flowSteps[window.appState.currentStep].id === 'ulasan' && direction > 0) {
                // This is the "Hantar Analisis" action
                window.updateState({ currentStep: newStepIndex, assessmentCompleted: true });
            } else if (newStepIndex >= 0 && newStepIndex < flowSteps.length) {
                window.updateState({ currentStep: newStepIndex });
            }
        };

        // --- MODIFICATION START: Update renderApp to lock tabs and buttons ---
        window.renderApp = () => {
            const appContainer = document.getElementById('app-container');
            if (!window.appState.authReady || !window.appState.isAuthenticated) {
                appContainer.innerHTML = window.renderLogin();
                return;
            }
            
            const currentStepIndex = window.appState.currentStep;
            const score = window.calculateScore(); 
            const isUlasanStep = flowSteps[currentStepIndex].id === 'ulasan';
            const isResultStep = flowSteps[currentStepIndex].id === 'result';
            const isCompleted = window.appState.assessmentCompleted;

            // Logic to disable "Hantar Analisis" if questions are unanswered
            const allQuestionsAnswered = score.totalAnswered === score.totalScoredQuestions;
            const hantarAnalisisDisabled = isUlasanStep && !allQuestionsAnswered;

            const nextButtonText = isUlasanStep ? 'Hantar Analisis' : 'Seterusnya';
            const clientName = window.appState.answers.nama_perniagaan || 'Klien eHalalGAP';

            // Warning message if on 'Ulasan' step and questions are missing
            let warningHtml = '';
            if (isUlasanStep && !allQuestionsAnswered) {
                const unansweredCount = score.totalScoredQuestions - score.totalAnswered;
                warningHtml = `
                <div class="mt-6 p-4 bg-yellow-50 border-l-4 border-yellow-400 text-yellow-800 rounded-lg shadow-md">
                    <p class="font-bold">Perhatian:</p>
                    <p>Anda masih ada <strong>${unansweredCount}</strong> soalan yang belum dijawab di tab-tab sebelumnya. Butang "Hantar Analisis" akan diaktifkan setelah semua soalan dijawab.</p>
                </div>`;
            }

            const introductionHtml = `<div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 w-full"><div class="mb-8 p-6 bg-white rounded-xl shadow-lg"><h2 class="text-2xl font-bold text-gray-800 mb-2">Selamat Datang, ${clientName}!</h2><p class="text-base leading-relaxed text-gray-600">Dashboard ini direka untuk membantu anda menjejaki ketersediaan halal, menggambarkan kemajuan, dan menguruskan tindakan penambahbaikan di satu tempat.</p></div></div>`;
            
            appContainer.innerHTML = `<div class="min-h-screen bg-gray-50 flex flex-col">
                <header class="hero-bg py-4 px-4 shadow-lg">
                    <div class="max-w-6xl mx-auto text-white flex justify-between items-center">
                        <div>
                            <h1 class="text-xl sm:text-2xl font-extrabold">Semakan Jurang Halal (eHalalGAP)</h1>
                            <p class="mt-1 text-sm text-gray-200">Analisis Kendiri untuk Pensijilan Halal</p>
                        </div>
                        <button onclick="window.logoutClient()" class="bg-red-500 text-white hover:bg-red-600 px-4 py-2 rounded-lg text-sm font-semibold flex items-center"><svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>Log Keluar</button>
                    </div>
                </header>
                <main class="flex-grow max-w-6xl mx-auto py-8 w-full">
                    ${introductionHtml}
                    <div class="px-4 sm:px-6 lg:px-8" id="main-content-start">
                        ${isCompleted ? '' : window.renderProgress(score)} <!-- Hide progress if completed -->
                        <nav class="flex overflow-x-auto whitespace-nowrap space-x-2 sm:space-x-4 mb-8 p-1 bg-white rounded-xl shadow-md" id="tab-nav-container">
                            ${flowSteps.map((step, index) => {
                                const isResultTab = step.id === 'result';
                                let tabClasses = 'py-3 px-3 sm:px-4 text-sm font-medium transition rounded-lg';
                                
                                if (isCompleted) {
                                    // Assessment is done, lock all tabs except 'result'
                                    if (isResultTab) {
                                        tabClasses += ' tab-active bg-teal-50 cursor-pointer';
                                    } else {
                                        tabClasses += ' cursor-not-allowed text-gray-400 bg-gray-50';
                                    }
                                } else {
                                    // Assessment is in progress
                                    if (isResultTab) {
                                        tabClasses += ' cursor-not-allowed text-gray-400 bg-gray-50';
                                    } else {
                                        tabClasses += ` cursor-pointer ${index === currentStepIndex ? 'tab-active bg-teal-50' : 'text-gray-600 hover:bg-gray-100'}`;
                                    }
                                }
                                return `<button onclick="window.goToStep(${index})" class="${tabClasses}">${step.title.replace(/^\d+\.\s*/, '')}</button>`;
                            }).join('')}
                        </nav>
                        <div class="p-6 bg-white rounded-xl shadow-2xl border-t-4 border-teal-500">
                            ${window.renderTabContent()}
                        </div>
                        
                        ${warningHtml} <!-- Show warning message if needed -->

                        <div class="mt-8 flex flex-col sm:flex-row sm:justify-between sm:items-center space-y-4 sm:space-y-0">
                            <button onclick="window.changeStep(-1)" ${currentStepIndex === 0 || isCompleted ? 'disabled' : ''} class="w-full sm:w-auto btn-secondary px-6 py-3 rounded-xl font-semibold disabled:opacity-50 flex items-center justify-center">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>Sebelumnya
                            </button>
                            <div class="flex flex-col items-center space-y-2 w-full sm:w-auto">
                                <button onclick="window.manualSave()" ${isResultStep || isCompleted ? 'disabled' : ''} id="save-progress-btn" class="w-full sm:w-auto inline-flex items-center justify-center btn-secondary px-6 py-3 rounded-xl font-semibold hover:bg-teal-100 text-teal-700 disabled:opacity-50">
                                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path></svg>Simpan Kemajuan
                                </button>
                                <p id="save-status-message" class="text-xs text-gray-500 opacity-0 transition"></p>
                            </div>
                            <button onclick="window.changeStep(1)" ${isResultStep || isCompleted || hantarAnalisisDisabled ? 'disabled' : ''} class="w-full sm:w-auto btn-primary px-6 py-3 rounded-xl text-white font-semibold disabled:opacity-50 flex items-center justify-center">
                                ${nextButtonText}
                                <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
                            </button>
                        </div>
                    </div>
                </main>
                <footer class="bg-gray-800 text-white p-4 mt-8">
                    <div class="max-w-6xl mx-auto text-center text-sm"><p>&copy; Hak Cipta ACE UniKL MICET ${new Date().getFullYear()}.</p></div>
                </footer>
            </div>
            <div id="report-modal" class="modal">
                <div class="modal-content">
                    <div class="sticky top-0 bg-white border-b p-4 flex justify-between items-center rounded-t-xl z-10 print-hidden">
                        <h2 class="text-2xl font-bold">Preview Laporan Penuh</h2>
                        <button onclick="window.toggleModal(false)" class="text-gray-500 hover:text-gray-800"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
                    </div>
                    <div id="modal-report-body"></div>
                    <div class="sticky bottom-0 bg-gray-50 border-t p-4 flex justify-center rounded-b-xl z-10 space-x-4 print-hidden">
                        <button onclick="window.toggleModal(false)" class="btn-secondary px-6 py-3 rounded-xl font-semibold">Tutup</button>
                        <button onclick="window.downloadReportPDF()" class="btn-primary px-6 py-3 rounded-xl text-white font-semibold">Muat Turun PDF</button>
                    </div>
                </div>
            </div>`;
            // --- MODIFICATION END ---


            // --- MODIFICATION START: Scroll active tab into view ---
            // We need to wait a tiny bit for the DOM to update
            setTimeout(() => {
                const navContainer = document.getElementById('tab-nav-container');
                if (navContainer) {
                    const activeTab = navContainer.querySelector('.tab-active');
                    if (activeTab) {
                        activeTab.scrollIntoView({ 
                            behavior: 'smooth', 
                            block: 'nearest', 
                            inline: 'center' 
                        });
                    }
                }
            }, 0);
            // --- MODIFICATION END ---
        };
    </script>
</head>
<body>
    <div id="app-container">
        <div class="h-screen flex items-center justify-center">
            <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-teal-500"></div>
            <p class="ml-4 text-teal-600">Memuatkan Aplikasi...</p>
        </div>
    </div>
</body>
</html>

